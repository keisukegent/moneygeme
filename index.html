<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒãƒ¼ãƒ©ã‚¤ãƒ•ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï½œeãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ä½“é¨“ç‰ˆï¼ˆéŸ³å£°ãªã—ï¼‰</title>
<style>
  :root {
    --accent: #d06ba0;
    --accent-soft: #fbd5b5;
    --card-bg: rgba(255,255,255,0.94);
  }
  body {
    font-family: 'Hiragino Maru Gothic Pro', 'Yu Gothic', system-ui, sans-serif;
    background: linear-gradient(135deg, #f9e0e9, #d8e9f0);
    text-align: center;
    color: #444;
    padding: 20px;
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.8s ease;
  }
  h1 { color: #d06ba0; animation: fadeIn 1.2s ease; }
  #game {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 20px;
    max-width: 740px;
    margin: 22px auto;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    animation: slideUp 0.8s ease;
  }
  .row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  button {
    margin: 10px;
    padding: 12px 18px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(90deg, var(--accent), var(--accent-soft));
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

  .status { background: linear-gradient(90deg, #fff4fa, #f0faff); border-radius: 10px; padding: 12px; margin: 10px 0; animation: fadeIn 0.6s ease; }
  #event { font-size: 18px; margin: 18px 0; animation: fadeIn 0.6s ease; }

  /* ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒãƒŠãƒ¼ */
  .chapter-banner {
    background: linear-gradient(120deg, rgba(208,107,160,0.12), rgba(255,255,255,0.8));
    border: 1px solid rgba(208,107,160,0.2);
    border-radius: 16px;
    padding: 10px;
    margin-bottom: 12px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .chapter-banner small {
    display:block;
    font-size:12px;
    color:#777;
    letter-spacing: normal;
  }

  /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
  .meters {
    display:grid;
    gap:10px;
    margin:12px 0 18px;
  }
  .meter {
    text-align:left;
  }
  .meter-label {
    font-size:12px;
    color:#777;
    margin-bottom:4px;
  }
  .meter-bar {
    height:12px;
    border-radius:999px;
    background:#f2f2f4;
    overflow:hidden;
  }
  .meter-fill {
    display:block;
    height:100%;
    border-radius:999px;
    background:linear-gradient(90deg, var(--accent), var(--accent-soft));
    width:30%;
    transition:width 0.4s ease;
  }
  .meter-value {
    font-size:12px;
    color:#555;
    margin-top:4px;
  }

  /* ã‚³ãƒ¼ãƒãƒœãƒƒã‚¯ã‚¹ */
  .coach-box { display: none; align-items: center; gap: 12px; max-width: 600px; margin: 8px auto 0; padding: 12px; border-radius: 14px; background: #fff9fd; border: 1px solid #f3d4e5; box-shadow: 0 4px 10px rgba(208,107,160,0.08); opacity: 0; transform: translateY(8px); }
  .coach-avatar { width: 56px; height: 56px; border-radius: 50%; overflow: hidden; background: #ffeaf4; display: grid; place-items: center; }
  .coach-avatar img { width: 56px; height: 56px; display: block; }
  .coach-name { font-weight: 700; color: #c65e97; font-size: 14px; margin-bottom: 4px; }
  .coach-text { text-align: left; line-height: 1.6; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* ãã‚‰ãã‚‰æ¼”å‡º */
  .sparkle { position: fixed; width: 10px; height: 10px; background: radial-gradient(circle, #fff 0%, transparent 70%); border-radius: 50%; animation: fall 4s linear infinite; opacity: 0.7; pointer-events: none; }
  @keyframes fall { 0% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

  .note { font-size: 12px; color: #777; }
  .pill { display:inline-block; padding:4px 10px; border-radius: 999px; background:#f3e7ef; color:#a34f84; font-size:12px; margin-left:6px; }

  /* ã‚³ãƒ¼ãƒé¸æŠç”»é¢ */
  .select-wrap { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:14px; max-width: 700px; margin: 10px auto; }
  .coach-card { background:#fff; border:1px solid #f0d2e2; border-radius:16px; padding:14px; box-shadow:0 6px 14px rgba(0,0,0,0.06); transition: transform .2s, box-shadow .2s; }
  .coach-card:hover { transform: translateY(-3px); box-shadow:0 10px 18px rgba(0,0,0,0.1); }
  .coach-card img { width: 120px; height:120px; border-radius: 50%; display:block; margin:6px auto 10px; }
  .coach-title { font-weight:700; color:#b74387; margin-bottom:6px; }
  .coach-desc { font-size:13px; color:#666; min-height: 3.2em; }

  /* ãƒãƒƒã‚¸æ£š */
  .badge-shelf {
    margin:18px auto 8px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(110px,1fr));
    gap:8px;
  }
  .badge {
    border:1px dashed rgba(208,107,160,0.3);
    border-radius:12px;
    padding:8px;
    font-size:12px;
    color:#bba7b4;
    min-height:68px;
  }
  .badge.unlocked {
    border-style:solid;
    background:#fff9fd;
    color:#c65e97;
    box-shadow:0 4px 10px rgba(208,107,160,0.12);
  }
  .badge .badge-icon { font-size:20px; }
  .badge .badge-label { font-weight:600; margin-top:4px; }

  /* ãƒ­ã‚°ãƒœãƒ¼ãƒ‰ */
  .log-board {
    text-align:left;
    margin-top:14px;
    background:#fdf7ff;
    border:1px solid rgba(208,107,160,0.25);
    border-radius:14px;
    padding:12px;
    max-height:200px;
    overflow:auto;
  }
  .log-title {
    font-size:13px;
    color:#a34f84;
    margin-bottom:8px;
    font-weight:600;
  }
  .log-entry {
    padding:6px 0;
    border-bottom:1px dashed rgba(0,0,0,0.07);
    display:flex;
    justify-content:space-between;
    gap:8px;
    font-size:13px;
  }
  .log-entry:last-child { border-bottom:none; }
  .log-month { font-weight:600; color:#c65e97; }
  .log-choice { flex:1; }
  .log-delta { color:#5e7a2f; font-size:12px; white-space:nowrap; }

  /* ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒœãƒ¼ãƒ‰ */
  .mission-board {
    margin:18px auto 0;
    padding:14px;
    border-radius:16px;
    background:#f2f8ff;
    border:1px solid rgba(118,139,255,0.3);
    text-align:left;
  }
  .mission-title {
    font-weight:700;
    font-size:15px;
    color:#5c6fd8;
    margin-bottom:4px;
  }
  .mission-desc {
    font-size:13px;
    color:#566178;
    margin-bottom:10px;
  }
  .mission-progress {
    font-size:12px;
    color:#334155;
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
  }
  .mission-progress-bar {
    height:8px;
    border-radius:999px;
    background:#dfe6ff;
    overflow:hidden;
  }
  .mission-progress-fill {
    display:block;
    height:100%;
    border-radius:999px;
    background:linear-gradient(90deg,#768bff,#b6c3ff);
    width:0%;
    transition:width 0.4s ease;
  }
  .mission-tags {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:11px;
  }
  .mission-tags span {
    background:#fff;
    border:1px solid rgba(118,139,255,0.3);
    border-radius:999px;
    padding:2px 10px;
  }
  .mission-reward {
    font-size:12px;
    color:#4c5aa9;
    margin-top:8px;
  }

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  .toast {
    position:fixed;
    left:50%;
    top:20px;
    transform:translate(-50%,-20px);
    background:rgba(255,255,255,0.95);
    border-radius:14px;
    padding:12px 18px;
    box-shadow:0 8px 20px rgba(0,0,0,0.18);
    border:1px solid rgba(208,107,160,0.3);
    opacity:0;
    pointer-events:none;
    transition: all 0.3s ease;
    z-index:99;
    font-weight:600;
  }
  .toast.visible {
    opacity:1;
    transform:translate(-50%,0);
  }

  .hidden { display:none !important; }

  /* ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay {
    position:fixed;
    inset:0;
    background:rgba(10,7,25,0.68);
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    pointer-events:none;
    transition:opacity 0.3s ease;
    z-index:90;
  }
  .modal-overlay.visible {
    opacity:1;
    pointer-events:auto;
  }
  .story-modal {
    width:min(90vw,640px);
    background:linear-gradient(135deg,#181533,#2b2159);
    border-radius:24px;
    padding:24px;
    color:#f8e9ff;
    box-shadow:0 20px 40px rgba(0,0,0,0.4);
  }
  .story-header {
    font-size:18px;
    font-weight:700;
    letter-spacing:0.05em;
    color:#a78bfa;
    margin-bottom:12px;
    text-transform:uppercase;
  }
  .story-text {
    font-size:16px;
    line-height:1.7;
    min-height:120px;
    border-radius:16px;
    padding:16px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.07);
  }
  .story-navigation {
    display:flex;
    justify-content:flex-end;
    margin-top:18px;
    gap:10px;
  }
  .story-navigation button {
    background:linear-gradient(120deg,#a855f7,#ec4899);
    border:none;
    border-radius:12px;
    color:#fff;
    font-size:14px;
    padding:10px 18px;
    cursor:pointer;
  }
  .story-navigation button.secondary {
    background:rgba(255,255,255,0.12);
  }

  /* å¯¾è©±ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .dialogue-window {
    width:min(90vw,620px);
    background:#ffffff;
    border-radius:20px;
    padding:20px;
    box-shadow:0 20px 40px rgba(0,0,0,0.25);
    color:#333;
  }
  .dialogue-title {
    font-weight:700;
    font-size:16px;
    color:#c65e97;
    margin-bottom:10px;
  }
  .dialogue-list {
    max-height:260px;
    overflow:auto;
    margin-bottom:14px;
  }
  .dialogue-line {
    margin-bottom:12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .dialogue-speaker {
    font-weight:700;
    min-width:70px;
    font-size:13px;
    color:#a34f84;
  }
  .dialogue-text {
    flex:1;
    background:#fdf4ff;
    border-radius:12px;
    padding:10px 12px;
    border:1px solid rgba(198,94,151,0.2);
    font-size:14px;
    line-height:1.5;
  }
  .dialogue-actions {
    text-align:right;
  }
  .dialogue-actions button {
    background:linear-gradient(120deg,#f472b6,#fb7185);
    color:#fff;
    border:none;
    border-radius:12px;
    padding:10px 20px;
    font-size:14px;
    cursor:pointer;
  }

  /* ç›®æ¨™ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
  .goal-indicator {
    margin:8px 0 14px;
    background:#fff9fd;
    border:1px solid rgba(198,94,151,0.25);
    border-radius:14px;
    padding:10px;
    font-size:13px;
    color:#8a4c79;
  }
  .goal-indicator strong { color:#c65e97; }
  .goal-progress-row {
    display:flex;
    justify-content:space-between;
    font-size:12px;
    margin-top:4px;
  }
  .goal-progress-row span:last-child { color:#555; }

  /* ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  .goal-modal {
    width:min(90vw,640px);
    background:#fff;
    border-radius:26px;
    padding:24px;
    text-align:left;
    box-shadow:0 30px 40px rgba(0,0,0,0.2);
  }
  .goal-modal h3 {
    margin-top:0;
    color:#c65e97;
  }
  .goal-form {
    display:grid;
    gap:12px;
    margin-top:12px;
  }
  .goal-field {
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid rgba(198,94,151,0.25);
    border-radius:12px;
    padding:10px;
    background:#fff6fb;
  }
  .goal-field label {
    min-width:100px;
    font-weight:600;
    color:#a34f84;
  }
  .goal-field input {
    flex:1;
    padding:8px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.1);
    font-size:14px;
  }
  .goal-actions {
    margin-top:16px;
    text-align:right;
  }
  .goal-actions button {
    border:none;
    border-radius:12px;
    padding:10px 18px;
    font-size:14px;
    cursor:pointer;
  }
  .goal-actions .secondary {
    background:#f0edf5;
    color:#555;
    margin-right:10px;
  }
  .goal-actions .primary {
    background:linear-gradient(120deg,#f472b6,#fb7185);
    color:#fff;
  }
  .goal-explain {
    margin-top:14px;
    background:#fff5fa;
    border:1px solid rgba(198,94,151,0.2);
    border-radius:14px;
    padding:12px;
    font-size:13px;
    color:#74405f;
  }
  .goal-explain strong { display:block; margin-bottom:6px; color:#c65e97; }
  .goal-explain ul { padding-left:18px; margin:0; }
  .goal-explain li { margin:4px 0; }
  .goal-question-title {
    font-weight:700;
    color:#c65e97;
    margin-bottom:6px;
  }
  .goal-option-list {
    display:grid;
    gap:10px;
    margin:12px 0;
  }
  .goal-option-list button {
    width:100%;
    text-align:left;
    border-radius:12px;
    border:1px solid rgba(198,94,151,0.35);
    background:#fff;
    color:#7a3e61;
    padding:10px 14px;
    font-size:14px;
  }
  .goal-option-list button.selected {
    border:2px solid var(--accent);
    background:rgba(208,107,160,0.08);
    color:#4b1f34;
  }
  .goal-summary {
    background:#fff9fd;
    border:1px solid rgba(198,94,151,0.25);
    border-radius:16px;
    padding:14px;
    margin-top:12px;
  }
  .goal-summary h4 {
    margin:0 0 8px;
    color:#c65e97;
  }
  .goal-summary-list {
    list-style:none;
    padding:0;
    margin:0 0 8px;
  }
  .goal-summary-list li {
    margin:4px 0;
    color:#62364f;
  }
  .goal-tags {
    list-style:none;
    padding:0;
    margin:6px 0 0;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    font-size:12px;
  }
  .goal-tags li {
    background:#fff;
    border:1px solid rgba(198,94,151,0.3);
    border-radius:999px;
    padding:2px 8px;
  }
  .goal-actions .text-link {
    border:none;
    background:none;
    color:#a34f84;
    text-decoration:underline;
    font-size:13px;
    margin-right:auto;
    padding:0;
    cursor:pointer;
  }
  .review-window {
    width:min(90vw,650px);
    background:#fffdfc;
    border-radius:22px;
    padding:20px;
    box-shadow:0 24px 48px rgba(0,0,0,0.25);
    text-align:left;
    border:1px solid rgba(208,107,160,0.2);
  }
  .review-title {
    font-size:18px;
    font-weight:700;
    color:#c34781;
  }
  .review-subtitle {
    font-size:13px;
    color:#666;
    margin-bottom:12px;
  }
  .review-metrics {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(150px,1fr));
    gap:10px;
    margin-bottom:12px;
  }
  .review-metric {
    background:#fff9fd;
    border-radius:14px;
    border:1px solid rgba(198,94,151,0.2);
    padding:10px;
    font-size:13px;
    color:#633548;
  }
  .review-metric strong {
    display:block;
    color:#c65e97;
    font-size:15px;
  }
  .review-list {
    list-style:none;
    padding:0;
    margin:0;
    font-size:13px;
    color:#463442;
  }
  .review-list li {
    padding:6px 0;
    border-bottom:1px dashed rgba(0,0,0,0.08);
  }
  .review-list li:last-child {
    border-bottom:none;
  }
  .review-feedback {
    margin-top:12px;
    background:#fff2f6;
    border:1px solid rgba(201,77,120,0.3);
    border-radius:16px;
    padding:12px;
    font-size:13px;
    color:#5a243c;
    line-height:1.6;
  }
  .review-feedback strong {
    color:#c02f5c;
  }
  .intro-window {
    width:min(90vw,640px);
    background:#fff;
    border-radius:24px;
    padding:20px;
    text-align:left;
    box-shadow:0 24px 48px rgba(0,0,0,0.25);
    border:1px solid rgba(208,107,160,0.25);
  }
  .intro-header {
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:12px;
  }
  .intro-avatar {
    width:86px;
    height:86px;
    border-radius:24px;
    overflow:hidden;
    background:#fff5fb;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid rgba(208,107,160,0.2);
  }
  .intro-avatar img {
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .intro-coach-name {
    font-size:18px;
    font-weight:700;
    color:#c34781;
  }
  .intro-coach-desc {
    font-size:13px;
    color:#5d3750;
  }
  .intro-points {
    margin:0;
    padding:0;
    list-style:none;
    display:grid;
    gap:10px;
    margin-top:14px;
  }
  .intro-points li {
    background:#fff9fd;
    border-radius:14px;
    border:1px solid rgba(198,94,151,0.2);
    padding:12px;
  }
  .intro-points h4 {
    margin:0 0 4px;
    font-size:14px;
    color:#a3346a;
  }
  .intro-body {
    font-size:13px;
    color:#4c3341;
    line-height:1.6;
  }
  .quiz-window {
    width:min(90vw,620px);
    background:#ffffff;
    border-radius:24px;
    padding:22px;
    box-shadow:0 24px 48px rgba(0,0,0,0.3);
    text-align:left;
  }
  .quiz-title {
    font-size:17px;
    font-weight:700;
    color:#5c358a;
  }
  .quiz-question {
    margin:8px 0 14px;
    font-size:15px;
    color:#2f1f3c;
    line-height:1.5;
  }
  .quiz-options {
    display:grid;
    gap:10px;
    margin-bottom:14px;
  }
  .quiz-options button {
    border-radius:14px;
    border:1px solid rgba(92,53,138,0.3);
    padding:12px;
    text-align:left;
    font-size:14px;
    background:#f8f5ff;
    color:#2f1f3c;
    cursor:pointer;
  }
  .quiz-options button.correct {
    border-color:#28a745;
    background:#edfff4;
  }
  .quiz-options button.incorrect {
    border-color:#d93052;
    background:#fff0f3;
  }
  .quiz-feedback {
    min-height:48px;
    font-size:13px;
    color:#4c1f37;
    margin-bottom:10px;
  }
</style>
</head>
<body>
<h1>ğŸ’– ãƒãƒãƒ¼ãƒ©ã‚¤ãƒ•ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ ğŸ’° <span class="pill">eãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ä½“é¨“ï¼ˆéŸ³å£°ãªã—ï¼‰</span></h1>
<div id="game">
  <div id="status" class="status"></div>
  <div id="chapterBanner" class="chapter-banner"></div>
  <div id="goalIndicator" class="goal-indicator hidden"></div>
  <div class="meters">
    <div class="meter">
      <div class="meter-label">ğŸ’µ æ‰€æŒé‡‘</div>
      <div class="meter-bar"><span id="moneyFill" class="meter-fill"></span></div>
      <div class="meter-value" id="moneyValue"></div>
    </div>
    <div class="meter">
      <div class="meter-label">ğŸ’– å¹¸ç¦åº¦</div>
      <div class="meter-bar"><span id="happyFill" class="meter-fill"></span></div>
      <div class="meter-value" id="happyValue"></div>
    </div>
  </div>
  <div id="event"></div>
  <div id="choices" class="row"></div>
  <div id="coach" class="coach-box"></div>
  <div id="badgeShelf" class="badge-shelf"></div>
  <div id="missionBoard" class="mission-board hidden"></div>
  <div id="log" class="log-board">
    <div class="log-title">Decision Log</div>
    <p style="margin:0; font-size:12px; color:#777;">ã¾ã é¸æŠãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
  </div>
</div>
<p class="note">â€» ã¾ãšã‚³ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæ‰€è¦ç´„7ã€œ10åˆ†ï¼‰ã€‚ç”»åƒã¯å·®ã—æ›¿ãˆå¯èƒ½ã§ã™ã€‚</p>
<div id="toast" class="toast"></div>
<div id="storyOverlay" class="modal-overlay">
  <div class="story-modal">
    <div class="story-header" id="storyChapter"></div>
    <div class="story-text" id="storyText"></div>
    <div class="mission-reward" id="storyMissionHint"></div>
    <div class="story-navigation">
      <button id="storySkip" class="secondary">ã‚¹ã‚­ãƒƒãƒ—</button>
      <button id="storyNext">æ¬¡ã¸</button>
    </div>
  </div>
</div>
<div id="dialogueOverlay" class="modal-overlay">
  <div class="dialogue-window">
    <div class="dialogue-title">ã‚³ãƒ¼ãƒã¨ã®å¯¾è©±</div>
    <div id="dialogueList" class="dialogue-list"></div>
    <div class="dialogue-actions">
      <button id="dialogueNext">æ¬¡ã®æœˆã¸</button>
    </div>
  </div>
</div>
<div id="goalOverlay" class="modal-overlay">
  <div class="goal-modal">
    <h3>ğŸ¯ æ–°å¹´ã®ãƒãƒ¼ãƒˆï¼†ãƒãƒãƒ¼ç›®æ¨™</h3>
    <p style="color:#555; margin-bottom:10px;">ã‚³ãƒ¼ãƒã¨çŸ­ã„å¯¾è©±ã‚’ã—ã¦ã€ä»Šå¹´ã®â€œå®ˆã‚Šâ€ã¨â€œä½™ç™½â€ã‚’ä¸€ç·’ã«è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚</p>
    <div id="goalConversation">
      <div id="goalQuestionTitle" class="goal-question-title"></div>
      <p id="goalQuestionText"></p>
      <div id="goalOptions" class="goal-option-list"></div>
      <div id="goalCoachNote" class="goal-explain"></div>
    </div>
    <div id="goalSummaryView" class="goal-summary hidden"></div>
    <div id="goalManualForm" class="goal-form hidden">
      <div class="goal-field">
        <label for="manualGoalMoney">ğŸ’µ æ‰€æŒé‡‘</label>
        <input type="number" id="manualGoalMoney" min="20000" step="1000">
        <span>å††ã‚’ç›®æŒ‡ã™</span>
      </div>
      <div class="goal-field">
        <label for="manualGoalHappy">ğŸ’– å¹¸ç¦åº¦</label>
        <input type="number" id="manualGoalHappy" min="50" max="100">
        <span>ã‚’ã‚­ãƒ¼ãƒ—/é”æˆ</span>
      </div>
    </div>
    <div class="goal-actions" id="goalWizardActions">
      <button type="button" class="text-link" id="goalSkip">ã‚ã¨ã§æ±ºã‚ã‚‹</button>
      <button type="button" class="secondary" id="goalBackStep">æˆ»ã‚‹</button>
      <button type="button" class="primary" id="goalNextStep">æ¬¡ã¸</button>
    </div>
    <div class="goal-actions hidden" id="goalSummaryActions">
      <button type="button" class="secondary" id="goalManualToggle">åˆ¥ã®å€¤ã«ã™ã‚‹</button>
      <button type="button" class="primary" id="goalAcceptRecommendation">ã“ã®ææ¡ˆã§å†’é™ºé–‹å§‹</button>
    </div>
    <div class="goal-actions hidden" id="goalManualActions">
      <button type="button" class="secondary" id="goalManualBack">ææ¡ˆã«æˆ»ã‚‹</button>
      <button type="button" class="primary" id="goalManualConfirm">å…¥åŠ›ã—ãŸå€¤ã§é€²ã‚€</button>
    </div>
  </div>
</div>
<div id="reviewOverlay" class="modal-overlay">
  <div class="review-window">
    <div class="review-title" id="reviewTitle"></div>
    <div class="review-subtitle" id="reviewSubtitle"></div>
    <div class="review-metrics">
      <div class="review-metric">
        <strong id="reviewMoneySummary">--</strong>
        <span>æ‰€æŒé‡‘ã®æ¨ç§»</span>
      </div>
      <div class="review-metric">
        <strong id="reviewHappySummary">--</strong>
        <span>å¹¸ç¦åº¦ã®æ¨ç§»</span>
      </div>
      <div class="review-metric">
        <strong id="reviewTagSummary">--</strong>
        <span>ã‚ˆãé¸ã‚“ã ãƒ†ãƒ¼ãƒ</span>
      </div>
    </div>
    <div>
      <div style="font-weight:600; color:#a34f84; margin-bottom:4px;">ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>
      <ul class="review-list" id="reviewHighlightList"></ul>
    </div>
    <div class="review-feedback" id="reviewFeedbackBox"></div>
    <div class="goal-actions" style="text-align:right; margin-top:14px;">
      <button type="button" class="primary" id="reviewCloseButton">æ¬¡ã®åŠå¹´ã¸é€²ã‚€</button>
    </div>
  </div>
</div>
<div id="coachIntroOverlay" class="modal-overlay">
  <div class="intro-window">
    <div class="intro-header">
      <div class="intro-avatar"><img id="coachIntroAvatar" src="" alt=""></div>
      <div>
        <div class="intro-coach-name" id="coachIntroName"></div>
        <div class="intro-coach-desc" id="coachIntroDesc"></div>
      </div>
    </div>
    <div class="intro-body" id="coachIntroOpening"></div>
    <ul class="intro-points" id="coachIntroPoints"></ul>
    <div class="goal-actions" style="text-align:right; margin-top:10px;">
      <button type="button" class="primary" id="coachIntroContinue">æ•°å­—ã®ç´„æŸã¸é€²ã‚€</button>
    </div>
  </div>
</div>
<div id="quizOverlay" class="modal-overlay">
  <div class="quiz-window">
    <div class="quiz-title" id="quizTitle"></div>
    <div class="quiz-question" id="quizQuestion"></div>
    <div class="quiz-options" id="quizOptions"></div>
    <div class="quiz-feedback" id="quizFeedback"></div>
    <div class="goal-actions" style="text-align:right;">
      <button type="button" class="primary" id="quizContinue" disabled>æ¬¡ã¸é€²ã‚€</button>
    </div>
  </div>
</div>
<script>
const chapterInfo = [
  { label: 'Chapter 1: Spring Reset', sub: 'ç¿’æ…£ã‚’æ•´ãˆã¦åœŸå°ã‚’ã¤ãã‚‹' },
  { label: 'Chapter 2: Summer Drive', sub: 'æŒ‘æˆ¦ã¨çµŒé¨“å€¤ã‚’é‡ã­ã‚‹å­£ç¯€' },
  { label: 'Chapter 3: Autumn Balance', sub: 'æ”»å®ˆã®ãƒãƒ©ãƒ³ã‚¹å†èª¿æ•´' },
  { label: 'Chapter 4: Winter Celebration', sub: '1å¹´ã®æˆæœã‚’å‘³ã‚ã†' },
  { label: 'Chapter 5: Renewal Sprint', sub: '2å¹´ç›®ã®æ˜¥ã€æˆ¦ç•¥ã‚’ç£¨ãç›´ã™' },
  { label: 'Chapter 6: Collaboration Bloom', sub: 'äººã¨ã®ã¤ãªãŒã‚Šã§æŒ‘æˆ¦ã‚’åºƒã’ã‚‹' },
  { label: 'Chapter 7: Legacy Autumn', sub: 'å®ˆã‚Šã¨ç¶™æ‰¿ã‚’æ„è­˜ã™ã‚‹å­£ç¯€' },
  { label: 'Chapter 8: Vision Winter', sub: 'æœªæ¥ã®é’å†™çœŸã‚’æãåˆ‡ã‚‹' }
];

const seasonThemes = [
  { gradient: 'linear-gradient(135deg, #f9e0e9, #d8e9f0)', accent:'#d06ba0', soft:'#fbd5b5' },
  { gradient: 'linear-gradient(135deg, #ffe0d2, #fff1c9)', accent:'#ff8a5c', soft:'#ffd0a7' },
  { gradient: 'linear-gradient(135deg, #e6eeff, #f3e1ff)', accent:'#768bff', soft:'#c7d1ff' },
  { gradient: 'linear-gradient(135deg, #f5e7ff, #e0f7ff)', accent:'#a05cd0', soft:'#d3b3f7' },
  { gradient: 'linear-gradient(135deg, #fff5da, #ffe0eb)', accent:'#ff8ab8', soft:'#ffd6e8' },
  { gradient: 'linear-gradient(135deg, #e1ffe4, #d6f4ff)', accent:'#2fb285', soft:'#7adde9' },
  { gradient: 'linear-gradient(135deg, #ffe8d6, #ffeacd)', accent:'#e07a5f', soft:'#f2cc8f' },
  { gradient: 'linear-gradient(135deg, #ede9fe, #d7efff)', accent:'#6d6de8', soft:'#a5b4fc' }
];

const badgeCatalog = [
  { id:'investor', icon:'ğŸ“ˆ', title:'æŠ•è³‡ãƒ‡ãƒ“ãƒ¥ãƒ¼', desc:'æŠ•è³‡ã¾ãŸã¯æµ·å¤–æŠ•è³‡ã«æŒ‘æˆ¦ã—ãŸ' },
  { id:'wellness', icon:'ğŸ’ª', title:'ã‚¦ã‚§ãƒ«ãƒã‚¹ç•ªé•·', desc:'å¥åº·é–¢é€£ã‚’ç¶™ç¶šã—ãŸ' },
  { id:'planner', icon:'ğŸ—‚ï¸', title:'è¨­è¨ˆå›³ãƒã‚¹ã‚¿ãƒ¼', desc:'è¨ˆç”»ãƒ»ç¯€ç´„ã‚’ç©ã¿ä¸Šã’ãŸ' },
  { id:'globetrotter', icon:'ğŸŒ', title:'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒãƒãƒ¼', desc:'æµ·å¤–æŠ•è³‡ã‚’æœ¬æ ¼åŒ–ã•ã›ãŸ' },
  { id:'harmony', icon:'ğŸŒˆ', title:'ãƒãƒ”ãƒã‚¹70+', desc:'å¹¸ç¦åº¦70ã‚’çªç ´ã—ãŸ' }
];

const statImportance = [
  {
    key: 'money',
    title: 'ğŸ’µ æ‰€æŒé‡‘ = å®ˆã‚Šã¨æŒ‘æˆ¦ã®ç‡ƒæ–™',
    text: 'ç”Ÿæ´»é˜²è¡›è²»ã‚’å®ˆã‚ŠãªãŒã‚‰ã€æŒ‘æˆ¦è³‡é‡‘ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‹ã“ã¨ã§ã€Œå®‰å¿ƒã—ã¦æ”»ã‚ã‚‹ã€çŠ¶æ…‹ã‚’ä½œã‚Œã‚‹ã€‚æ„Ÿæƒ…ã§ã¯ãªãè¨­è¨ˆã§å‹•ã‘ã‚‹ã‚ˆã†ã«ã€ã¾ãšç¾é‡‘ã®åšã¿ã‚’æ±ºã‚ã‚ˆã†ã€‚'
  },
  {
    key: 'happy',
    title: 'ğŸ’– å¹¸ç¦åº¦ = æ„æ€æ±ºå®šã®è³ª',
    text: 'ç¡çœ ãƒ»é£Ÿãƒ»ã”è¤’ç¾ãªã©ã®ä½™ç™½ãŒå‰Šã‚‰ã‚Œã‚‹ã¨åˆ¤æ–­åŠ›ãŒæ€¥é™ä¸‹ã€‚å¹¸ç¦åº¦ã®ç›®æ¨™ã‚’å…ˆã«æ±ºã‚ã¦ã€æ•°å­—ã¨åŒã˜ãã‚‰ã„å¤§äº‹ã«æ‰±ã†ã¨ã€æŒ‘æˆ¦ãŒé•·ç¶šãã™ã‚‹ã€‚'
  }
];

const seminarQuizBankYear1 = [
  {
    title: 'NISAã‚»ãƒŸãƒŠãƒ¼å¾©ç¿’ã‚¯ã‚¤ã‚º',
    question: 'ã¤ã¿ãŸã¦æŠ•è³‡ã§æ„è­˜ã™ã¹ãã€Œé•·æœŸãƒ»åˆ†æ•£ãƒ»ä½ã‚³ã‚¹ãƒˆã€ã®ã†ã¡ã€æœ€ã‚‚è‡ªåˆ†ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã‚„ã™ã„ã®ã¯ï¼Ÿ',
    choices: [
      { label:'ç›¸å ´ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å®Œç’§ã«èª­ã‚€ã“ã¨', correct:false, happy:-4, feedback:'ç›¸å ´ã¯èª­ã‚ãªã„å‰æã€‚èª­ã‚‚ã†ã¨ã™ã‚‹ã»ã©å¿ƒã‚‚ãŠé‡‘ã‚‚å‰Šã‚‰ã‚Œã¡ã‚ƒã†ã€‚' },
      { label:'ä¿æœ‰éŠ˜æŸ„ã®åˆ†æ•£æ•°ã‚’æ¯æœˆå¤‰ãˆã‚‹ã“ã¨', correct:false, happy:-3, feedback:'åˆ†æ•£ã¯å¤§åˆ‡ã ã‘ã©ã€æ•°ã‚’ã„ã˜ã‚Šç¶šã‘ã‚‹ã®ã¯ãƒªã‚¹ã‚¯ç®¡ç†ãŒãƒ–ãƒ¬ã‚„ã™ã„ã€‚' },
      { label:'ã‚³ã‚¹ãƒˆã®ä½ã„å•†å“ã‚’é¸ã³ç¶šã‘ã‚‹ã“ã¨', correct:true, happy:5, feedback:'æ‰‹æ•°æ–™ã¯è‡ªåˆ†ã§é¸ã¹ã‚‹å”¯ä¸€ã®ç¢ºå®šè¦ç´ ã€‚ä½ã‚³ã‚¹ãƒˆã¯é•·æœŸã§åŠ¹ãè¤‡åˆ©ã ã‚ˆã€‚' }
    ],
    explanation: 'ç›¸å ´ã‚’èª­ã‚€ã‚ˆã‚Šã€ã‚³ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå†ç¾æ€§ã®é«˜ã„ãƒªã‚¿ãƒ¼ãƒ³å‘ä¸Šç­–ã€‚'
  },
  {
    title: 'ä¿é™ºã‚»ãƒŸãƒŠãƒ¼å¾©ç¿’ã‚¯ã‚¤ã‚º',
    question: 'ã€Œå®ˆã‚Šã€ã‚’æ•´ãˆã‚‹ã¨ãã€æœ€åˆã«è¦‹ç›´ã™ã¹ããªã®ã¯ï¼Ÿ',
    choices: [
      { label:'è²¯è“„å‹ä¿é™ºã‚’ã™ãè§£ç´„ã—ã¦ç¾é‡‘åŒ–ã™ã‚‹', correct:false, happy:-4, feedback:'ç„¦ã£ã¦è§£ç´„ã™ã‚‹ã¨å…ƒæœ¬å‰²ã‚Œã®ãƒªã‚¹ã‚¯ã€‚ã¾ãšã¯å…¨ä½“è¨­è¨ˆã‚’ç¢ºèªã—ã‚ˆã†ã€‚' },
      { label:'ä¿éšœã®é‡è¤‡ã‚„éå‰°ãªç‰¹ç´„ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹', correct:true, happy:4, feedback:'å¿…è¦ä¿éšœé¡ã¨ç”Ÿæ´»é˜²è¡›è²»ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹ç›´ã™ã®ãŒâ€œå®ˆã‚Šâ€ã®ç¬¬ä¸€æ­©ã€‚' },
      { label:'æŠ•è³‡æ ã‚’å¢—ã‚„ã—ã¦ãƒªã‚¹ã‚¯ã‚’å–ã‚‹', correct:false, happy:-5, feedback:'å®ˆã‚Šã®è©±ã‹ã‚‰æ”»ã‚ã«é€ƒã’ã‚‹ã¨ã€çµå±€ã©ã¡ã‚‰ã‚‚ä¸­é€”åŠç«¯ã«ãªã‚‹ã‚ˆã€‚' }
    ],
    explanation: 'ä¿é™ºã¯ç›®çš„ã”ã¨ã®éä¸è¶³ã‚’ãƒã‚§ãƒƒã‚¯â†’ä½™å‰°ã¯æ”»ã‚ã¸ã€è¶³ã‚Šãªã‘ã‚Œã°è£œã†ã®ãŒã‚»ã‚ªãƒªãƒ¼ã€‚'
  },
  {
    title: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚»ãƒŸãƒŠãƒ¼å¾©ç¿’ã‚¯ã‚¤ã‚º',
    question: 'å®¶è¨ˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚’æ•´ãˆã‚‹æœ€åˆã®ä¸€æ­©ã¨ã—ã¦æœ‰åŠ¹ãªã®ã¯ï¼Ÿ',
    choices: [
      { label:'äº¤éš›è²»ãªã©å¤‰å‹•è²»ã‚’æœˆã”ã¨ã«æœ€é©åŒ–ã™ã‚‹', correct:false, happy:-3, feedback:'å¤‰å‹•è²»ã®æœ€é©åŒ–ã¯å¤§äº‹ã ã‘ã©ã€ã¾ãšã¯åœŸå°ã®å›ºå®šè²»ã‹ã‚‰ãŒé‰„å‰‡ã€‚' },
      { label:'å›ºå®šè²»ã¨ç›®çš„åˆ¥å£åº§ã‚’ä»•åˆ†ã‘ã‚‹', correct:true, happy:4, feedback:'ãŠé‡‘ã®æµã‚Œã‚’ç›®çš„åˆ¥ã«åˆ†ã‘ã‚‹ã¨ã€Œè¿·ã„ã€ãªãã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå›ã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆã€‚' },
      { label:'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦è§£ç´„ã™ã‚‹', correct:false, happy:-4, feedback:'å¿…è¦ãªä»•çµ„ã¿ã¾ã§å£Šã™ã¨åˆ©ä¾¿æ€§ã‚‚ç®¡ç†ã‚‚æ‚ªåŒ–ã—ãŒã¡ã€‚' }
    ],
    explanation: 'å›ºå®šè²»ãƒ»ç›®çš„åˆ¥ã®ä»•çµ„ã¿åŒ–ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚’è¦‹ãˆã‚‹åŒ–ã—ã€æŒ‘æˆ¦è³‡é‡‘ã‚’ç¢ºä¿ã—ã‚„ã™ããªã‚‹ã€‚'
  },
  {
    title: 'ãƒ¡ãƒ³ã‚¿ãƒ«ãƒãƒãƒ¼è¬›åº§ã‚¯ã‚¤ã‚º',
    question: 'å¹¸ç¦åº¦ãŒè½ã¡ã¦ããŸã¨ãã«è¦‹ç›´ã™ã¹ãå„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ï¼Ÿ',
    choices: [
      { label:'æŠ•è³‡é¡ã‚’ã™ãå¢—ã‚„ã—ã¦æ°—åˆ†ã‚’ä¸Šã’ã‚‹', correct:false, happy:-5, feedback:'æ„Ÿæƒ…ã§æ”»ã‚ã‚‹ã¨ãƒªã‚¹ã‚¯ãŒè·³ã­ä¸ŠãŒã‚‹ã€‚ã¾ãšã¯å¿ƒã®ä½™ç™½ã‚’æ•´ãˆã‚ˆã†ã€‚' },
      { label:'ä¼‘æ¯ã¨ã”è¤’ç¾ã®å…·ä½“çš„ãªäºˆå®šã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¥ã‚Œã‚‹', correct:true, happy:5, feedback:'å¹¸ç¦åº¦ã‚’æ•°å€¤åŒ–ã—ã€ä½™ç™½ã‚’â€œäºˆå®šåŒ–â€ã™ã‚‹ã“ã¨ã§åˆ¤æ–­åŠ›ã‚‚æˆ»ã‚‹ã‚ˆã€‚' },
      { label:'ã¨ã«ã‹ãä»•äº‹é‡ã‚’å¢—ã‚„ã—ã¦å¿˜ã‚Œã‚‹', correct:false, happy:-4, feedback:'é€ƒé¿ã§è©°ã‚è¾¼ã‚€ã¨ç‡ƒãˆå°½ããŒåŠ é€Ÿã™ã‚‹ã ã‘ã€‚' }
    ],
    explanation: 'å¹¸ç¦åº¦ï¼æ„æ€æ±ºå®šã®è³ªã€‚ã”è¤’ç¾ãƒ»ä¼‘æ¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«çµ„ã¿è¾¼ã¿ã€ä»•çµ„ã¿ã§å›å¾©ã‚’ç¢ºä¿ã—ã‚ˆã†ã€‚'
  }
];

const seminarQuizBankYear2 = [
  {
    title: 'æµ·å¤–æŠ•è³‡ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚¯ã‚¤ã‚º',
    question: 'ç‚ºæ›¿ãƒªã‚¹ã‚¯ã«å‚™ãˆã¤ã¤æµ·å¤–ETFã¸æŠ•è³‡ã™ã‚‹éš›ã€ã¯ã˜ã‚ã«æ„è­˜ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯ï¼Ÿ',
    choices: [
      { label:'ç‚ºæ›¿ã®å€¤å‹•ãã‚’äºˆæƒ³ã—ã¦å£²è²·ã‚’ç¹°ã‚Šè¿”ã™', correct:false, happy:-4, feedback:'é »ç¹ãªå£²è²·ã¯ã‚³ã‚¹ãƒˆã¨ãƒ¡ãƒ³ã‚¿ãƒ«è² è·ãŒå¢—ã™ã ã‘ã€‚' },
      { label:'æŠ•è³‡æ¯”ç‡ã¨ç›®çš„ã«åˆã£ãŸé€šè²¨ã‚’æ±ºã‚ã¦ãŠã', correct:true, happy:5, feedback:'ç›®çš„åˆ¥ã«é€šè²¨ã¨æ¯”ç‡ã‚’æ±ºã‚ã¦ãŠãã¨ãƒ–ãƒ¬ãªã„è¨­è¨ˆã«ãªã‚‹ã‚ˆã€‚' },
      { label:'ç‚ºæ›¿ãƒ˜ãƒƒã‚¸å•†å“ã ã‘ã‚’æŒã¡ã€ä»–ã¯æ’é™¤ã™ã‚‹', correct:false, happy:-3, feedback:'ãƒ˜ãƒƒã‚¸ä¸€æœ¬ã ã¨ã‚³ã‚¹ãƒˆå¢—ï¼†æŸ”è»Ÿæ€§ãŒãªããªã‚‹ã€‚' }
    ],
    explanation: 'ã€Œã©ã®ç›®çš„ã§ã„ãã‚‰å¤–è²¨ã«ç½®ãã‹ã€ã‚’æ±ºã‚ãŸä¸Šã§ã€ãƒ˜ãƒƒã‚¸æœ‰ç„¡ã‚„éŠ˜æŸ„ã‚’é¸ã‚“ã§ã„ãã€‚'
  },
  {
    title: 'ã‚³ãƒ©ãƒœå‰¯æ¥­ã‚»ãƒŸãƒŠãƒ¼ã‚¯ã‚¤ã‚º',
    question: 'ä»²é–“ã¨å‰¯æ¥­ã‚’é€²ã‚ã‚‹ã¨ãã€ã¾ãšå–ã‚Šæ±ºã‚ã‚‹ã¹ãé‡è¦äº‹é …ã¯ï¼Ÿ',
    choices: [
      { label:'åˆ©ç›ŠãŒå‡ºãŸã‚‰ãã®å ´ã®æ°—åˆ†ã§åˆ†é…ã™ã‚‹', correct:false, happy:-4, feedback:'ãƒ«ãƒ¼ãƒ«ãŒã‚ã„ã¾ã„ã ã¨é–¢ä¿‚æ€§ãŒå´©ã‚Œã‚„ã™ã„ã€‚' },
      { label:'å½¹å‰²ãƒ»æ™‚é–“ãƒ»ãŠé‡‘ã®åˆ†é…ãƒ«ãƒ¼ãƒ«ã‚’æ–‡æ›¸åŒ–ã™ã‚‹', correct:true, happy:4, feedback:'æ•°å€¤ã¨å½¹å‰²ã‚’æ˜æ–‡åŒ–ã™ã‚‹ã¨è²¬ä»»ç¯„å›²ãŒæ˜ç¢ºã«ãªã‚‹ã‚ˆã€‚' },
      { label:'æœ€åˆã‹ã‚‰å¤§ããªè¨­å‚™æŠ•è³‡ã«è¸ã¿åˆ‡ã‚‹', correct:false, happy:-3, feedback:'å°ã•ãæ¤œè¨¼ã™ã‚‹åŸå‰‡ã‚’å¿˜ã‚Œã‚‹ã¨ãƒªã‚¹ã‚¯éå¤šã€‚' }
    ],
    explanation: 'å‰¯æ¥­ã‚³ãƒ©ãƒœã¯â€œæ•°å­—ã¨å½¹å‰²â€ã‚’æœ€åˆã«å¯è¦–åŒ–ã€‚æ±ºã‚ãªã„ã¾ã¾é€²ã‚€ã¨æ„Ÿæƒ…ãƒˆãƒ©ãƒ–ãƒ«ã«ã€‚'
  },
  {
    title: 'ãƒ¬ã‚¬ã‚·ãƒ¼è¨­è¨ˆã‚¯ã‚¤ã‚º',
    question: 'è³‡ç”£é˜²è¡›ã¨ç¶™æ‰¿ã‚’è€ƒãˆã‚‹ã¨ãã€æœ€åˆã«ç€æ‰‹ã™ã‚‹ã¨è‰¯ã„ã®ã¯ï¼Ÿ',
    choices: [
      { label:'æŠ•è³‡ã‚’å…¨ã¦è§£ç´„ã—ã¦ç¾é‡‘åŒ–ã™ã‚‹', correct:false, happy:-5, feedback:'æ¥µç«¯ãªè§£ç´„ã¯ãƒãƒ£ãƒ³ã‚¹ã‚’å¤±ã†ã ã‘ã€‚' },
      { label:'å®¶æ—å†…ã§è³‡ç”£ä¸€è¦§ã¨æ„å‘ã‚’å…±æœ‰ã™ã‚‹', correct:true, happy:5, feedback:'è³‡ç”£ã®ä¸€è¦§ã¨æ„å‘å…±æœ‰ãŒãƒ¬ã‚¬ã‚·ãƒ¼è¨­è¨ˆã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã€‚' },
      { label:'ä¿é™ºã‚„ä¿¡è¨—ã®å¥‘ç´„ã‚’ã™ãã«å¢—ã‚„ã™', correct:false, happy:-3, feedback:'ç›®çš„æ•´ç†ã‚’ã›ãšå¥‘ç´„ã‚’å¢—ã‚„ã™ã¨ã‚³ã‚¹ãƒˆéå¤šã€‚' }
    ],
    explanation: 'ã¾ãšâ€œè¦‹ãˆã‚‹åŒ–ã¨å…±æœ‰â€â†’å¿…è¦ãªã‚‰å°‚é–€å®¶ã¨è¨­è¨ˆã€‚å®¶æ—ã¨è©±ã›ã‚‹åœŸå°ãŒæœ€å„ªå…ˆã€‚'
  }
];

const tagLabels = {
  save:'å®¶è¨ˆæ•´ç†',
  plan:'æœªæ¥è¨­è¨ˆ',
  health:'ã‚¦ã‚§ãƒ«ãƒã‚¹',
  invest:'æŠ•è³‡',
  overseas:'æµ·å¤–æŠ•è³‡',
  side:'å‰¯æ¥­ãƒ»æŒ‘æˆ¦',
  learn:'å­¦ã³',
  joy:'ã”è¤’ç¾',
  rebalance:'ãƒªãƒãƒ©ãƒ³ã‚¹',
  protect:'å®ˆã‚Š',
  wait:'å¾…ã¤åˆ¤æ–­',
  risk:'ãƒªã‚¹ã‚¯',
  rest:'æ•´ãˆã‚‹'
};

const chapterStories = [
  {
    slides: [
      { text: 'å¹´å§‹ã®æœã€‚ã‚ãªãŸã¯ã‚³ãƒ¼ãƒã¨æ¸©ã‹ãªãƒãƒ¼ãƒ–ãƒ†ã‚£ãƒ¼ã‚’é£²ã¿ãªãŒã‚‰ã€<br>ã€Œä»Šå¹´ã“ãã€ãŠé‡‘ã®åœŸå°ã‚’æ•´ãˆã‚ˆã†ã€ã¨èª“ã„ã¾ã—ãŸã€‚' },
      { text: '1ã€œ3æœˆã¯â€œæš®ã‚‰ã—ã®ãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒ³ãƒ—æœŸâ€ã€‚å®¶è¨ˆã‚„å¥åº·ã®ç¿’æ…£ã¥ãã‚Šã«æ³¨åŠ›ã—ã€<br>æ¬¡ã®æŒ‘æˆ¦ã«å‚™ãˆã‚‹ã“ã¨ãŒãƒ†ãƒ¼ãƒã§ã™ã€‚' }
    ],
    mission: {
      id: 'foundation',
      title: 'æš®ã‚‰ã—ã®åœŸå°ã¥ãã‚Š',
      desc: 'ç¯€ç´„ãƒ»è¨ˆç”»ãƒ»å¥åº·ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é‡ã­ã€å¹´é–“ã®ãƒ™ãƒ¼ã‚¹ã‚’ç¯‰ã“ã†ã€‚',
      tags: ['save','plan','health'],
      target: 2,
      reward: {money: 3000, happy: 4 },
      hint: 'å›ºå®šè²»ã‚„ç¿’æ…£ã‚’æ•´ãˆã‚‹é¸æŠãŒã‚²ãƒ¼ã‚¸ã‚’é€²ã‚ã¾ã™ã€‚'
    }
  },
  {
    slides: [
      { text: 'å¤ãŒè¿‘ã¥ãã“ã‚ã€è¡—ã«ã¯æ–°ã—ã„å­¦ã³ã‚„å‰¯æ¥­ã®ãƒãƒ£ãƒ³ã‚¹ãŒã‚ãµã‚Œã¦ã„ã¾ã™ã€‚<br>ã‚³ãƒ¼ãƒã¯ã€Œå°ã•ãã¦ã‚‚è¡Œå‹•ã‚’é‡ã­ã‚Œã°ã€çµŒé¨“å€¤ã«ãªã‚‹ã‚ˆã€ã¨èƒŒä¸­ã‚’æŠ¼ã—ã¾ã™ã€‚' },
      { text: '4ã€œ6æœˆã¯â€œãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ‰ãƒ©ã‚¤ãƒ–æœŸâ€ã€‚å‰¯åå…¥ã¥ãã‚Šã‚„æŠ•è³‡ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã€<br>è‡ªåˆ†ã®å¯èƒ½æ€§ã‚’åºƒã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚' }
    ],
    mission: {
      id: 'drive',
      title: 'æŒ‘æˆ¦ã®ã‚®ã‚¢ã‚’å…¥ã‚Œã‚‹',
      desc: 'å‰¯æ¥­ãƒ»å­¦ã³ãƒ»æŠ•è³‡ã‚’é¸ã³ã€ãƒ‰ã‚­ãƒ‰ã‚­ã‚’è¡Œå‹•ã«å¤‰ãˆã‚ˆã†ã€‚',
      tags: ['side','learn','invest'],
      target: 2,
      reward: {happy: 5 },
      hint: 'æŒ‘æˆ¦ç³»ã®é¸æŠè‚¢ã§ã‚²ãƒ¼ã‚¸ãŒä¼¸ã³ã¾ã™ã€‚'
    }
  },
  {
    slides: [
      { text: 'ç§‹é¢¨ãŒå¹ãé ƒã€è³‡ç”£é…åˆ†ã‚„ãƒªã‚¹ã‚¯ã®æ•´å‚™ãŒæ°—ã«ãªã‚Šå§‹ã‚ã¾ã™ã€‚<br>ã‚³ãƒ¼ãƒã¯ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³è¡¨ã‚’åºƒã’ã€ã€Œã“ã“ã§ä¸€åº¦ã€ä½œæˆ¦ä¼šè­°ã‚’ã—ã‚ˆã†ã€ã¨ææ¡ˆã€‚' },
      { text: '7ã€œ9æœˆã¯â€œãƒãƒ©ãƒ³ã‚¹èª¿æ•´æœŸâ€ã€‚å®ˆã‚Šã¨æ”»ã‚ã®ãƒ«ãƒ¼ãƒ«ã‚’å†ç¢ºèªã—ã¦ã€<br>æºã‚‰ãã«å¼·ã„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚' }
    ],
    mission: {
      id: 'balance',
      title: 'æ”»å®ˆãƒãƒ©ãƒ³ã‚¹ä¼šè­°',
      desc: 'ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ»å®ˆã‚Šãƒ»è¨ˆç”»ç³»ã®é¸æŠã§ã€è¨­è¨ˆå›³ã‚’ç£¨ãç›´ãã†ã€‚',
      tags: ['rebalance','protect','plan'],
      target: 2,
      reward: {money: 2000 },
      hint: 'ãƒãƒ©ãƒ³ã‚¹ç³»ã®é¸æŠã§ã‚²ãƒ¼ã‚¸ãŒä¸Šæ˜‡ã€‚'
    }
  },
  {
    slides: [
      { text: 'å†¬ã®ã‚¤ãƒ«ãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒç¯ã‚‹ã“ã‚ã€1å¹´ã®ç©ã¿ä¸Šã’ã‚’æŒ¯ã‚Šè¿”ã‚‹æ™‚é–“ãŒã‚„ã£ã¦ãã¾ã—ãŸã€‚<br>â€œä½•ã‚’å®ˆã‚Šã€ä½•ã«å–œã³ã‚’ä½¿ã†ï¼Ÿâ€ã‚³ãƒ¼ãƒã¨ã®å¯¾è©±ãŒæ·±ã¾ã‚Šã¾ã™ã€‚' },
      { text: '10ã€œ12æœˆã¯â€œç¥ç¥­ã¨è¨­è¨ˆã®æœŸâ€ã€‚ã”è¤’ç¾ã¨è¨ˆç”»ã‚’ãƒãƒ©ãƒ³ã‚¹ã•ã›ã€<br>æ¥å¹´ã¸ã®å¸ƒçŸ³ã‚’æ‰“ã¡ãªãŒã‚‰1å¹´ã‚’ç· ã‚ããã‚Šã¾ã—ã‚‡ã†ã€‚' }
    ],
    mission: {
      id: 'celebration',
      title: 'ç¥ç¥­ã¨æ¬¡ã®è¨­è¨ˆ',
      desc: 'ã”è¤’ç¾ãƒ»è¨ˆç”»ãƒ»å®ˆã‚Šã®é¸æŠã§ã€å¿ƒåœ°ã‚ˆã„ç· ã‚ããã‚Šã‚’å¶ãˆã‚ˆã†ã€‚',
      tags: ['joy','plan','protect'],
      target: 2,
      reward: {happy: 8 },
      hint: 'å–œã³ã‚„è¨ˆç”»ã®é¸æŠã§ã‚²ãƒ¼ã‚¸ãŒæº€ã¡ã¾ã™ã€‚'
    }
  },
  {
    slides: [
      { text: '2å¹´ç›®ã®æ˜¥ã€‚å»å¹´ã®å­¦ã³ã‚’æŠ±ãˆã¦ã€æ–°ã—ã„åœ°å›³ã‚’æãã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆ°æ¥ã€‚<br>ã‚³ãƒ¼ãƒã¯ã€Œã“ã“ã‹ã‚‰æœ¬ç•ªã€æˆ¦ç•¥ã‚’ç£¨ã“ã†ã€ã¨å¾®ç¬‘ã¿ã¾ã™ã€‚' },
      { text: '13ã€œ15æœˆã¯â€œæˆ¦ç•¥ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæœŸâ€ã€‚ç©ã¿ä¸Šã’ãŸè³‡ç”£ã‚’ã©ã†è‚²ã¦ã‚‹ã‹ã€<br>åºƒã„è¦–ç‚¹ã§æˆ¦ç•¥ã‚’æ´—ç·´ã•ã›ã¾ã—ã‚‡ã†ã€‚' }
    ],
    mission: {
      id: 'renewal',
      title: 'æˆ¦ç•¥ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ',
      desc: 'æŠ•è³‡ãƒ»æµ·å¤–ãƒ»è¨­è¨ˆã®é¸æŠã§2å¹´ç›®ã®è»Œé“ã‚’æã“ã†ã€‚',
      tags: ['invest','overseas','plan'],
      target: 3,
      reward: {money: 4000 },
      hint: 'è³‡ç”£é‹ç”¨ã‚„è¨­è¨ˆç³»ã®é¸æŠã§ã‚²ãƒ¼ã‚¸ãŒä¼¸ã³ã¾ã™ã€‚'
    }
  },
  {
    slides: [
      { text: 'åˆå¤ã€ä»²é–“ã‚„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¨ã®ã‚³ãƒ©ãƒœã®è©±é¡ŒãŒå¢—ãˆã¦ãã¾ã—ãŸã€‚<br>ã‚³ãƒ¼ãƒã¯ã€Œäººã¨ç¹‹ãŒã‚‹ã¨ã€è¡Œå‹•ã®å¹…ã¯ä¸€æ°—ã«åºƒãŒã‚‹ã‚ˆã€ã¨é¼“èˆã—ã¾ã™ã€‚' },
      { text: '16ã€œ18æœˆã¯â€œã‚³ãƒ©ãƒœæŒ‘æˆ¦æœŸâ€ã€‚å‰¯æ¥­ãƒ»å­¦ã³ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•ã§<br>çµŒé¨“ã®å¹…ã‚’åºƒã’ã€æ¥½ã—ã¿ãªãŒã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€‚' }
    ],
    mission: {
      id: 'collab',
      title: 'ã‚³ãƒ©ãƒœæŒ‘æˆ¦',
      desc: 'å‰¯æ¥­ãƒ»å­¦ã³ãƒ»å–œã³ã®é¸æŠã§å…±å‰µãƒ¢ãƒ¼ãƒ‰ã‚’ä½œã‚ã†ã€‚',
      tags: ['side','learn','joy'],
      target: 3,
      reward: {happy: 6 },
      hint: 'äººã¨ã®ã¤ãªãŒã‚Šã‚’æ„è­˜ã™ã‚‹é¸æŠè‚¢ã§å‰é€²ã—ã¾ã™ã€‚'
    }
  },
  {
    slides: [
      { text: 'ç§‹ã‚’å‰ã«ã€å®ˆã‚Šã¨ç¶™æ‰¿ã®è©±é¡ŒãŒæ°—ã«ãªã‚Šå§‹ã‚ã¾ã—ãŸã€‚<br>ã‚³ãƒ¼ãƒã¯ã€Œæœªæ¥ã®è‡ªåˆ†ã¨å¤§åˆ‡ãªäººãŸã¡ã¸ã€è¨­è¨ˆå›³ã‚’è´ˆã‚ã†ã€ã¨èªã‚Šã¾ã™ã€‚' },
      { text: '19ã€œ21æœˆã¯â€œãƒ¬ã‚¬ã‚·ãƒ¼èª¿æ•´æœŸâ€ã€‚å®ˆã‚Šã¨æ”»ã‚ã‚’å†ã³æ•´ãˆã€<br>å®¶æ—ã‚„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’å·»ãè¾¼ã‚“ã è¨­è¨ˆã«æ˜‡è¯ã—ã¦ã„ãã¾ã™ã€‚' }
    ],
    mission: {
      id: 'legacy',
      title: 'ãƒ¬ã‚¬ã‚·ãƒ¼èª¿æ•´',
      desc: 'å®ˆã‚Šãƒ»ãƒªãƒãƒ©ãƒ³ã‚¹ãƒ»è¨ˆç”»ã®é¸æŠã§ã€ãƒ–ãƒ¬ãªã„è»Œé“ã‚’ä½œã‚ã†ã€‚',
      tags: ['protect','rebalance','plan'],
      target: 2,
      reward: {money: 3000 },
      hint: 'å®ˆã‚Šã‚„å†è¨­è¨ˆã®é¸æŠã§ã‚²ãƒ¼ã‚¸ãŒé€²è¡Œã€‚'
    }
  },
  {
    slides: [
      { text: '2å¹´ç›®ã®å†¬ã€‚ãµãŸãŸã³ã‚¤ãƒ«ãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒç¯ã‚‹ãªã‹ã€<br>ã‚ãªãŸã¨ã‚³ãƒ¼ãƒã¯ã€Œã“ã®å…ˆ5å¹´ã®é’å†™çœŸã€ã‚’èªã‚Šåˆã„ã¾ã™ã€‚' },
      { text: '22ã€œ24æœˆã¯â€œãƒ“ã‚¸ãƒ§ãƒ³æå†™æœŸâ€ã€‚ã”è¤’ç¾ã¨æŠ•è³‡ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¤ã¤ã€<br>æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ç¶šãç‰©èªã‚’æãåˆ‡ã‚Šã¾ã—ã‚‡ã†ã€‚' }
    ],
    mission: {
      id: 'vision',
      title: 'ãƒ“ã‚¸ãƒ§ãƒ³å®Œæˆ',
      desc: 'å–œã³ãƒ»è¨ˆç”»ãƒ»æŠ•è³‡ã®é¸æŠã§ã€æ¬¡ç« ã¸ã®é’å†™çœŸã‚’å®Œæˆã•ã›ã‚ˆã†ã€‚',
      tags: ['joy','plan','invest'],
      target: 3,
      reward: {happy: 10 },
      hint: 'ç· ã‚ããã‚Šã®ã”è¤’ç¾ã‚„æŠ•è³‡ã§ã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã«ã€‚'
    }
  }
];

const unlockedBadges = new Set();
const logEntries = [];
let chapterIntroPlayed = chapterInfo.map(()=>false);
let activeMission = null;
let storyState = { active:false, chapterIndex:null, slide:0, onComplete:null };
let dialogueState = { active:false, onClose:null };
let awaitingDialogue = false;
let goalPlan = null;
// ===== ã‚³ãƒ¼ãƒç”»åƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã‚¤ãƒ³ãƒ©ã‚¤ãƒ³SVGã‚’data URIåŒ–ï¼‰ =====
const svg = (bg, face) => `data:image/svg+xml;utf8,` + encodeURIComponent(`
  <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>
    <defs>
      <radialGradient id='g' cx='50%' cy='40%' r='70%'>
        <stop offset='0%' stop-color='${bg}' stop-opacity='1'/>
        <stop offset='100%' stop-color='${bg}' stop-opacity='0.85'/>
      </radialGradient>
    </defs>
    <circle cx='60' cy='60' r='58' fill='url(#g)'/>
    ${face}
  </svg>`);
const faceSoft = "<circle cx='60' cy='62' r='34' fill='#ffe7ef'/><circle cx='48' cy='56' r='5' fill='#b66e97'/><circle cx='72' cy='56' r='5' fill='#b66e97'/><path d='M45 72 C60 84, 75 84, 90 72' stroke='#d087b2' stroke-width='4' fill='none' stroke-linecap='round'/>";
const faceSharp = "<circle cx='60' cy='62' r='34' fill='#e9f3ff'/><rect x='45' y='52' width='8' height='4' rx='2' fill='#4c6aa7'/><rect x='68' y='52' width='8' height='4' rx='2' fill='#4c6aa7'/><path d='M44 74 Q60 82 76 74' stroke='#5b79b6' stroke-width='4' fill='none' stroke-linecap='round'/>";
const faceBright = "<circle cx='60' cy='62' r='34' fill='#fff6d9'/><circle cx='48' cy='56' r='6' fill='#d68b00'/><circle cx='72' cy='56' r='6' fill='#d68b00'/><path d='M45 73 Q60 88 75 73' stroke='#f0a600' stroke-width='4' fill='none' stroke-linecap='round'/>";

// ç”»åƒURLã‚’ç‹¬è‡ªã®å†™çœŸã«å·®ã—æ›¿ãˆãŸã„å ´åˆã¯ã€ä¸‹è¨˜ã® src ã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„
const coachProfiles = {
  mina: {
    key: 'mina',
    name: 'ãƒŸãƒŠï¼ˆãƒŠãƒãƒ¥ãƒ©ãƒ«ï¼‰',
    avatarSrc: "images/chara1.jpg",
    desc: 'ã‚„ã•ã—ãå¯„ã‚Šæ·»ã†ã‚³ãƒ¼ãƒã€‚ç¿’æ…£ã¥ãã‚ŠãŒå¾—æ„ã€‚',
    quotes: {
      save:["â€œè²¯ã‚ã‚‹åŠ›â€ã¯å®‰å¿ƒã®åœŸå°ã­ã€‚å°ã•ãã¦ã‚‚ç©ã¿ä¸Šã’ã‚ˆã†ã€‚", "å›ºå®šè²»ã®è¦‹ç›´ã—ã¯ã€è‡ªç”±æ™‚é–“ã‚’ç”Ÿã‚€é­”æ³•ã‚ˆã€‚"],
      learn:["çŸ¥è­˜ã¯æœ€å¼·ã®å®‰å…¨è£…ç½®ã€‚å°‘ã—ãšã¤ã§å¤§ä¸ˆå¤«ã€‚", "ãƒ¡ãƒ¢ã‚’æ®‹ã™ã ã‘ã§ã€å­¦ã³ã¯å‘³æ–¹ã«ãªã‚‹ã‚ã€‚"],
      health:["ä½“ã®ãƒ¡ãƒ³ãƒ†ã¯é•·ç”Ÿãé…å½“ã€‚ã‚„ã•ã—ãç¶šã‘ã‚ˆã€‚", "å¥åº·ã¨å®¶è¨ˆã€ã©ã¡ã‚‰ã‚‚â€œæ•´ãˆã‚‹â€ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã­ã€‚"],
      side:["ãƒãƒ£ãƒ³ã‚¹ã¯å°ã•ãè©¦ã™ã€‚ç¶šã‘ã‚Œã°åŠ›ã«ãªã‚‹ã‚ã€‚", "åå…¥ã®æŸ±ãŒå¢—ãˆã‚‹ã¨ã€æ°—æŒã¡ã‚‚å®‰å®šã™ã‚‹ã®ã€‚"],
      joy:["æ€ã„å‡ºã¯å¹¸ç¦ã®é…å½“ã€‚ä½¿ã†å–œã³ã‚‚å¤§åˆ‡ã«ã­ã€‚", "å¿ƒãŒæº€ãŸã•ã‚Œã‚‹æ”¯å‡ºã¯ã€ã‚ãªãŸã®æ „é¤Šã‚ˆã€‚"],
      invest:["åˆ†æ•£ã¨é•·æœŸã€‚ç„¦ã‚‰ãšè‚²ã¦ã¦ã„ã“ã†ã€‚", "ç©ã¿ç«‹ã¦ã¯â€œæœªæ¥ã®è‡ªåˆ†â€ã¸ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€‚"],
      rebalance:["ç‚¹æ¤œã¯å¥å…¨ã€‚ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã¦æ·¡ã€…ã¨ã­ã€‚", "æ„Ÿæƒ…ã§ã¯ãªãè¨­è¨ˆå›³ã§å‹•ã‘ãŸã‚‰ååˆ†ã€‚"],
      wait:["â€œå¾…ã¤åŠ›â€ã‚‚ç«‹æ´¾ãªæˆ¦ç•¥ã‚ˆã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹æ¥µã‚ã¦ã€‚", "è¦³å¯Ÿã¯å­¦ã³ã€‚æ…Œã¦ãªãã¦ã„ã„ã®ã€‚"],
      risk:["å¤±æ•—ã¯å­¦ã³ã«å¤‰ã‚ã‚‹ã€‚æ¬¡ã¯ã‚‚ã£ã¨ä¸Šæ‰‹ãã„ãã‚ã€‚"],
      plan:["ç›®çš„åˆ¥ã«åˆ†ã‘ã‚‹ã¨ã€è¿·ã„ãŒæ¸›ã£ã¦ç¶šã‘ã‚„ã™ã„ã‚ˆã€‚"],
      protect:["å®ˆã‚Šã‚’æ•´ãˆã‚‹ã¨ã€æ”»ã‚ã‚‚è½ã¡ç€ã„ã¦ã§ãã‚‹ã®ã€‚"],
      overseas:["ä¸–ç•Œã«åˆ†æ•£ã™ã‚‹ã®ã¯ã€â€œä¸–ç•Œã§ãŠé‡‘ã‚’åƒã‹ã›ã‚‹â€ã“ã¨ã€‚ãƒ‰ãƒ«ã‚„ç‚ºæ›¿ã‚‚ã‚†ã£ãã‚Šå­¦ã¼ã†ã€‚"],
      ending:["ã“ã®ä¸€å¹´ã€ã‚ˆããŒã‚“ã°ã£ãŸã­ã€‚ç©ã¿é‡ã­ã¯è£åˆ‡ã‚‰ãªã„ã‚ˆã€‚", "æ•°å­—ã‚ˆã‚Šã€è€ƒãˆæ–¹ãŒè‚²ã£ãŸã“ã¨ãŒã„ã¡ã°ã‚“ã®æˆæœã‚ˆã€‚"]
    }
  },
  rei: {
    key: 'rei',
    name: 'ãƒ¬ã‚¤ï¼ˆã‚­ãƒ£ãƒªã‚¢ï¼‰',
    avatarSrc: "images/chara2.jpg",
    desc: 'ã‚­ãƒªãƒƒã¨ãƒ­ã‚¸ã‚«ãƒ«ã€‚è¨­è¨ˆÃ—å®Ÿè¡Œã§ä¼´èµ°ã€‚',
    quotes: {
      save:["å›ºå®šè²»ã®æœ€é©åŒ– = å¯å‡¦åˆ†æ™‚é–“ã®å‰µå‡ºã ã€‚", "å…ˆã«â€œãƒ«ãƒ¼ãƒ«â€ã‚’æ±ºã‚ã‚Œã°è¿·ã‚ãªã„ã€‚"],
      learn:["çŸ¥è­˜ã¯æœ€å¼·ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆã€‚é€±1ã®å­¦ã³ã‚’ã€‚", "ãƒ¡ãƒ¢ã¨æŒ¯ã‚Šè¿”ã‚Šã§å†ç¾æ€§ã‚’ä¸Šã’ã‚ˆã†ã€‚"],
      health:["è³‡ç”£å½¢æˆã¯é•·è·é›¢èµ°ã€‚ä½“èª¿ç®¡ç†ã¯KPIã ã€‚", "å°ã•ãªç¶™ç¶šãŒè¤‡åˆ©ã‚’ç”Ÿã‚€ã€‚"],
      side:["å°ã•ãè©¦ã—ã€æ•°å­—ã§è©•ä¾¡ã™ã‚‹ã€‚", "åå…¥ã®æŸ±ã‚’å¢—ã‚„ã›ã°è€æ€§ãŒä¸ŠãŒã‚‹ã€‚"],
      joy:["äºˆç®—åŒ–ã•ã‚ŒãŸä½™æš‡ã¯ã€é•·ç¶šãã™ã‚‹ã€‚", "å¹¸ç¦ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’æ„è­˜ã—ã‚ˆã†ã€‚"],
      invest:["é•·æœŸãƒ»åˆ†æ•£ãƒ»ä½ã‚³ã‚¹ãƒˆï¼šã“ã®åŸå‰‡ã‚’å®ˆã‚Œã€‚", "ç©ã¿ç«‹ã¦ã¯â€œæœªæ¥ã®è‡ªåˆ†ã¸ã®çµ¦ä¸â€ã€‚"],
      rebalance:["å¹´1ã€œ2å›ã®ãƒªãƒãƒ©ãƒ³ã‚¹ã‚’ãƒ«ãƒ¼ãƒãƒ³åŒ–ã€‚", "æ„Ÿæƒ…ã§ã¯ãªãè¨­è¨ˆå›³ã«å¾“ãŠã†ã€‚"],
      wait:["å¾…ã¤åˆ¤æ–­ã‚‚æˆ¦ç•¥ã€‚å¸‚å ´ã¯å¸¸ã«ã‚ã‚‹ã€‚", "è¦³å¯Ÿâ†’ä»®èª¬â†’æ¬¡ã®ä¸€æ‰‹ã€‚"],
      risk:["å¤±æ•—ã¯ãƒ‡ãƒ¼ã‚¿ã€‚å­¦ã³ã«å¤‰æ›ã—ã¦æ¬¡ã¸ã€‚"],
      plan:["ç›®çš„åˆ¥ã®è³‡é‡‘é…åˆ†ã§è¿·ã„ã‚’å‰Šæ¸›ã€‚"],
      protect:["å®ˆã‚ŠãŒæ•´ã†ã»ã©æ”»ã‚ã‚‰ã‚Œã‚‹ã€‚ãƒãƒ©ãƒ³ã‚¹ã ã€‚"],
      overseas:["é€šè²¨ãƒ»åœ°åŸŸã®åˆ†æ•£ã§ãƒœãƒ©è€æ€§ã‚’ä¸Šã’ã‚‹ã€‚"],
      ending:["æ€è€ƒã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæœ€å¤§ã®æˆæœã ã€‚ã‚ˆãã‚„ã£ãŸã€‚"]
    }
  },
  aoi: {
    key: 'aoi',
    name: 'ã‚¢ã‚ªã‚¤ï¼ˆãƒ•ã‚§ãƒŸãƒ‹ãƒ³ï¼‰',
    avatarSrc: "images/chara3.jpg",
    desc: 'æ˜ã‚‹ãå‰å‘ãã€‚ãƒ¢ãƒãƒ™UPæ‹…å½“ï¼',
    quotes: {
      save:["ã¡ã‚‡ã£ã¨ã®å·¥å¤«ã§æœªæ¥ãŒãµã‚ã£ã¨è»½ããªã‚‹ã‚ˆï¼", "å›ºå®šè²»ã‚’ã‚¹ãƒªãƒ ã«ã—ã¦ã€ã‚„ã‚ŠãŸã„ã“ã¨å¢—ã‚„ãâ™ª"],
      learn:["å­¦ã³ã¯ã”ã»ã†ã³ã€‚ä»Šæ—¥ã®ã²ã¨ã“ã¨ãƒ¡ãƒ¢ã‹ã‚‰ï¼", "çŸ¥ã£ã¦ã‚‹ã ã‘ã§ãƒ‰ã‚­ãƒ‰ã‚­ãŒãƒ¯ã‚¯ãƒ¯ã‚¯ã«ã€‚"],
      health:["ã‚³ã‚³ãƒ­ã¨ã‚«ãƒ©ãƒ€ã®ãƒ¡ãƒ³ãƒ†ã€ã„ã£ã—ã‚‡ã«ç¶šã‘ã‚ˆï¼", "å¥åº·ã¯ãƒãƒƒãƒ”ãƒ¼é…å½“ï¼"],
      side:["å°ã•ãå§‹ã‚ã‚‹â†’ç¶šã‘ã‚‹â†’æ°—ã¥ã„ãŸã‚‰ç©ã¿ä¸ŠãŒã£ã¦ã‚‹ï¼", "ã‚ãã‚ãã™ã‚‹æŒ‘æˆ¦ã€1æ­©ã„ã£ã¦ã¿ã‚ˆâ™ª"],
      joy:["æ€ã„å‡ºã¯ãšã£ã¨æ®‹ã‚‹è³‡ç”£ã ã‚ˆã€œï¼", "ã†ã‚Œã—ã„æ”¯å‡ºã¯ã€å¿ƒã®æ „é¤Šâ™¡"],
      invest:["ã‚³ãƒ„ã‚³ãƒ„æœ€å¼·ï¼é•·æœŸãƒ»åˆ†æ•£ã§ã®ã‚“ã³ã‚Šè‚²ã¦ã‚ˆã€‚", "æœªæ¥ã®è‡ªåˆ†ã¸ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€ä»Šæ—¥ã‚‚1å£â™ª"],
      rebalance:["ã¨ãã©ãæ•´ãˆã‚‹ã ã‘ã§ã‚¹ãƒƒã‚­ãƒªï¼", "è¨­è¨ˆå›³ã©ãŠã‚Šã«æˆ»ã›ã°OKã ã‚ˆã€œã€‚"],
      wait:["ã‚ã›ã‚‰ãªã„ã€ä»Šã¯è¦³å¯Ÿã‚¿ã‚¤ãƒ ã ã­ï¼", "æ¬¡ã®ãƒãƒ£ãƒ³ã‚¹ã€ãœã£ãŸã„æ¥ã‚‹ã‚ˆï¼"],
      risk:["ã†ã¾ãã„ã‹ãªã„æ—¥ã‚‚ã€å­¦ã³ãƒã‚¤ãƒ³ãƒˆGETï¼"],
      plan:["ç›®çš„åˆ¥ã§ã‚ã‘ã‚ã‘ã€è¿·ã‚ãšGOï¼"],
      protect:["å®ˆã‚ŠãŒã‚ã‚Œã°å®‰å¿ƒã—ã¦é€²ã‚ã‚‹ã‚ˆã­â™¡"],
      overseas:["ä¸–ç•Œã«ã²ã‚ã’ã¦ã€æœªæ¥ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã«ï¼"],
      ending:["1å¹´ãŠã¤ã‹ã‚Œã•ã¾ï¼ãœã‚“ã¶ãƒã‚«ãƒ©ã«ãªã£ã¦ã‚‹ã‚ˆâ™ª"]
    }
  }
};

let selectedCoach = null; // {key, name, avatarSrc, quotes}

// ===== ã‚²ãƒ¼ãƒ æœ¬ä½“ï¼ˆæ—¢å­˜ï¼‰ =====
const monthlyEvents = [
  { m: '1æœˆ', text: 'æ–°å¹´ã®æŠ±è² ã€‚ã¾ãšä½•ã‹ã‚‰å§‹ã‚ã‚‹ï¼Ÿ', choices:[
    {label:'å®¶è¨ˆã®è¦‹ç›´ã—ï¼ˆå›ºå®šè²»ã‚’å‰Šæ¸›ï¼‰', money:4000, happy:2, tag:'save'},
    {label:'å°ã•ãæŠ•è³‡ã‚’å§‹ã‚ã‚‹ï¼ˆã¤ã¿ãŸã¦ï¼‰', money:-3000, happy:4, tag:'invest'},
    {label:'å­¦ã³ã«æŠ•è³‡ï¼ˆå…¥é–€è¬›åº§ï¼‰', money:-2000, happy:5, tag:'learn'}
  ]},
  { m: '2æœˆ', text: 'å¥åº·è¨ºæ–­ã®çµæœãŒå±Šã„ãŸ', choices:[
    {label:'é‹å‹•ç¿’æ…£ã‚’ä½œã‚‹ï¼ˆã‚¸ãƒ ï¼‰', money:-4000, happy:10, tag:'health'},
    {label:'é£Ÿäº‹æ”¹å–„ï¼†æ•£æ­©ã‚’ç¶™ç¶š', money:-500, happy:7, tag:'health'},
    {label:'å…ˆå»¶ã°ã—ã«ã™ã‚‹', money:0, happy:-6, tag:'risk'}
  ]},
  { m: '3æœˆ', text: 'å‰¯æ¥­ã®ãƒãƒ£ãƒ³ã‚¹ãŒåˆ°æ¥ï¼', choices:[
    {label:'å°ã•ãæŒ‘æˆ¦ã—ã¦ã¿ã‚‹', money:8000, happy:4, tag:'side'},
    {label:'ä»Šã¯å­¦ã³ã‚’å„ªå…ˆ', money:-1000, happy:3, tag:'learn'},
    {label:'ç”Ÿæ´»ã‚’æ•´ãˆã‚‹ã“ã¨ã«é›†ä¸­', money:0, happy:3, tag:'rest'}
  ]},
  { m: '4æœˆ', text: 'å‹äººã‹ã‚‰æ—…è¡Œã®èª˜ã„', choices:[
    {label:'æ€ã„åˆ‡ã£ã¦è¡Œã', money:-8000, happy:18, tag:'joy'},
    {label:'ä»Šå›ã¯æ§ãˆã¦è²¯è“„', money:0, happy:-5, tag:'save'},
    {label:'è¿‘å ´ã§æ—¥å¸°ã‚Šã«', money:-2000, happy:10, tag:'joy'}
  ]},
  { m: '5æœˆ', text: 'ç›¸å ´ã®å€¤å‹•ããŒæ°—ã«ãªã‚‹', choices:[
    {label:'åˆ†æ•£ã‚’æ„è­˜ã—ã¦å°‘é¡è¿½åŠ ', money:-4000, happy:3, tag:'invest'},
    {label:'ä¸€éƒ¨ã‚’åˆ©ç›Šç¢ºå®š', money:3000, happy:-2, tag:'rebalance'},
    {label:'ç©ã¿ç«‹ã¦ã®ã¿ç¶™ç¶š', money:0, happy:2, tag:'wait'}
  ]},
  { m: '6æœˆ', text: 'æµ·å¤–æŠ•è³‡ã‚’æ¤œè¨ï¼ˆETF/æŠ•ä¿¡ï¼‰', choices:[
    {label:'ç±³å›½ETFã‚’å°‘é¡è³¼å…¥', money:-5000, happy:4, tag:'overseas'},
    {label:'ç‚ºæ›¿ã‚’å­¦ã‚“ã§ã‹ã‚‰å§‹ã‚ã‚‹', money:0, happy:3, tag:'learn'},
    {label:'å›½å†…ä¸­å¿ƒã§ç¶™ç¶š', money:0, happy:2, tag:'save'}
  ]},
  { m: '7æœˆ', text: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼šå††å®‰ãŒé€²è¡Œ', choices:[
    {label:'å¤–è²¨å»ºã¦ã®å‰²åˆã‚’ç‚¹æ¤œ', money:0, happy:1, tag:'rebalance'},
    {label:'å¤–è²¨ç©ç«‹ã‚’å°‘é¡é–‹å§‹', money:-3000, happy:3, tag:'overseas'},
    {label:'æ§˜å­ã‚’è¦‹ã‚‹', money:0, happy:0, tag:'wait'}
  ]},
  { m: '8æœˆ', text: 'NISAæ‹¡å……ã®ç‰¹é›†ã‚’è¦–è´', choices:[
    {label:'ã¤ã¿ãŸã¦æ ã‚’å¢—é¡', money:-4000, happy:4, tag:'invest'},
    {label:'æˆé•·æŠ•è³‡æ ã‚’ä¸€éƒ¨æ´»ç”¨', money:-3000, happy:3, tag:'invest'},
    {label:'ãƒ¡ãƒ¢ã ã‘æ®‹ã—ã¦æ¤œè¨', money:0, happy:1, tag:'wait'}
  ]},
  { m: '9æœˆ', text: 'ç‰©ä¾¡ä¸Šæ˜‡ã§ç”Ÿæ´»ã‚³ã‚¹ãƒˆãŒä¸ŠãŒã‚‹', choices:[
    {label:'å›ºå®šè²»ã®å†è¦‹ç›´ã—', money:3000, happy:1, tag:'save'},
    {label:'åå…¥ã‚¢ãƒƒãƒ—ç­–ã‚’æ¢ã™', money:0, happy:2, tag:'side'},
    {label:'ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨ãƒ»å®¶è¨ˆè¡“', money:1000, happy:2, tag:'save'}
  ]},
  { m: '10æœˆ', text: 'å®¶æ—ã®å‡ºè²»ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ•™è‚²/ä»‹è­·ãªã©ï¼‰', choices:[
    {label:'ç›®çš„åˆ¥å£åº§ã‹ã‚‰æ»å‡º', money:-5000, happy:4, tag:'plan'},
    {label:'æŠ•è³‡ã®ä¸€éƒ¨ã‚’å–ã‚Šå´©ã™', money:4000, happy:-2, tag:'rebalance'},
    {label:'æ”¯å‡ºã‚’åˆ†å‰²ã—è¨ˆç”»åŒ–', money:-2000, happy:3, tag:'plan'}
  ]},
  { m: '11æœˆ', text: 'è³‡ç”£ã‚’å®ˆã‚‹ï¼šä¿é™ºã¨ãƒªã‚¹ã‚¯å¯¾ç­–', choices:[
    {label:'ä¿éšœå†…å®¹ã‚’ç‚¹æ¤œãƒ»æœ€é©åŒ–', money:1000, happy:2, tag:'protect'},
    {label:'æœ€ä½é™ã«è¦‹ç›´ã—', money:2000, happy:1, tag:'protect'},
    {label:'å¤‰æ›´ã—ãªã„', money:0, happy:0, tag:'wait'}
  ]},
  { m: '12æœˆ', text: '1å¹´ã®æŒ¯ã‚Šè¿”ã‚Šã¨æ¥å¹´ã®è¨­è¨ˆ', choices:[
    {label:'è‡ªå‹•ç©ç«‹ï¼†ãƒªãƒãƒ©ãƒ³ã‚¹è¨­å®š', money:0, happy:4, tag:'rebalance'},
    {label:'æ¥å¹´ã®ç›®æ¨™ã¨äºˆç®—ã‚’ä½œæˆ', money:0, happy:5, tag:'plan'},
    {label:'ã”è¤’ç¾ã«å°ã•ãªæ—…è¡Œ', money:-3000, happy:14, tag:'joy'}
  ]},
  { m: '2å¹´ç›®1æœˆ', text: '2å¹´ç›®ã®ã‚¹ã‚¿ãƒ¼ãƒˆã€‚æ˜¨å¹´ã®è¨˜éŒ²ã‚’ã‚‚ã¨ã«æ–°æˆ¦ç•¥ã‚’æ¤œè¨', choices:[
    {label:'æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—æ”¹å–„æ¡ˆã‚’å³å®Ÿè¡Œ', money:3000, happy:2, tag:'plan'},
    {label:'ç©ç«‹é¡ã‚’æœˆ1ä¸‡å††ã‚¢ãƒƒãƒ—', money:-10000, happy:5, tag:'invest'},
    {label:'ã¾ãšã¯ä½“åˆ¶ã‚’æ•´ãˆã‚‹ï¼ˆä¼‘æ¯ï¼†æ£šå¸ï¼‰', money:0, happy:6, tag:'rest'}
  ]},
  { m: '2å¹´ç›®2æœˆ', text: 'å…±åŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãŠèª˜ã„ãŒå±Šã', choices:[
    {label:'å‰¯æ¥­ã¨ã—ã¦å‚ç”»ã™ã‚‹', money:9000, happy:6, tag:'side'},
    {label:'å‹‰å¼·ä¼šã ã‘å‚åŠ ã—ã¦çŸ¥è¦‹ã‚’å¾—ã‚‹', money:-2000, happy:4, tag:'learn'},
    {label:'ä»Šã¯æœ¬æ¥­ã«é›†ä¸­', money:0, happy:2, tag:'wait'}
  ]},
  { m: '2å¹´ç›®3æœˆ', text: 'å®¶æ—ã‚¤ãƒ™ãƒ³ãƒˆã«å‘ã‘ã¦ã®æº–å‚™', choices:[
    {label:'ç›®çš„åˆ¥å£åº§ã‚’å†æ•´å‚™', money:2000, happy:3, tag:'plan'},
    {label:'æ€ã„åˆ‡ã£ã¦ã‚µãƒ—ãƒ©ã‚¤ã‚ºæ—…è¡Œ', money:-7000, happy:16, tag:'joy'},
    {label:'ä¿é™ºãƒ—ãƒ©ãƒ³ã‚’è¦‹ç›´ã™', money:1500, happy:2, tag:'protect'}
  ]},
  { m: '2å¹´ç›®4æœˆ', text: 'æœ€æ–°ãƒ•ã‚£ãƒ³ãƒ†ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«ã®ç‰¹é›†', choices:[
    {label:'ãƒ„ãƒ¼ãƒ«ã‚’å°å…¥ã—ã¦æŠ•è³‡ã‚’è‡ªå‹•åŒ–', money:-4000, happy:5, tag:'invest'},
    {label:'ã¾ãšä½¿ã„ã“ãªã—è¬›åº§ã‚’å—è¬›', money:-2500, happy:4, tag:'learn'},
    {label:'æ—¢å­˜ãƒ„ãƒ¼ãƒ«ã§ååˆ†ã¨åˆ¤æ–­', money:0, happy:1, tag:'wait'}
  ]},
  { m: '2å¹´ç›®5æœˆ', text: 'ç‰©ä¾¡ä¸Šæ˜‡ç¬¬2æ³¢ã€‚ç”Ÿæ´»ã‚³ã‚¹ãƒˆãŒã˜ã‚ã‚Š', choices:[
    {label:'å…±åŒè³¼å…¥ã‚„ã‚·ã‚§ã‚¢ã§å›ºå®šè²»å‰Šæ¸›', money:4000, happy:3, tag:'save'},
    {label:'å‰¯åå…¥ã®æ–°æŸ±ã‚’ãƒªã‚µãƒ¼ãƒ', money:-1000, happy:5, tag:'side'},
    {label:'ä»Šã¯ã‚„ã‚Šãã‚Šè¡“ã§è€ãˆã‚‹', money:500, happy:1, tag:'plan'}
  ]},
  { m: '2å¹´ç›®6æœˆ', text: 'æµ·å¤–ç ”ä¿®ã®ãƒãƒ£ãƒ³ã‚¹ãŒå·¡ã£ã¦ãã‚‹', choices:[
    {label:'ç ”ä¿®ã«å‚åŠ ã—ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ‹¡å¤§', money:-12000, happy:10, tag:'learn'},
    {label:'ç¾åœ°æŠ•è³‡ã‚‚è¦–å¯Ÿã—å°‘é¡ã§æŒ‘æˆ¦', money:-6000, happy:6, tag:'overseas'},
    {label:'å›½å†…ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¬›åº§ã§ä»£æ›¿', money:-2000, happy:3, tag:'learn'}
  ]},
  { m: '2å¹´ç›®7æœˆ', text: 'å¸‚å ´ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒå†ã³ä¸Šæ˜‡', choices:[
    {label:'è³‡ç”£å…¨ä½“ã‚’è¦‹ç›´ã—ãƒªãƒãƒ©ãƒ³ã‚¹', money:0, happy:3, tag:'rebalance'},
    {label:'ç©ç«‹ã®ã¿ç¶™ç¶šã—æ§˜å­è¦‹', money:0, happy:1, tag:'wait'},
    {label:'å­¦ã‚“ã ãƒªã‚¹ã‚¯ç®¡ç†æ³•ã‚’æ¤œè¨¼', money:-1500, happy:2, tag:'risk'}
  ]},
  { m: '2å¹´ç›®8æœˆ', text: 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸»å‚¬ã—ã¦ã¿ãªã„ã‹ã¨ææ¡ˆ', choices:[
    {label:'ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã‚’ä¼ç”»ã—é–‹å‚¬', money:4000, happy:12, tag:'side'},
    {label:'äº¤æµä¼šã‚’é–‹ãä»²é–“ã¥ãã‚Š', money:-3000, happy:14, tag:'joy'},
    {label:'å‚åŠ ã®ã¿ã§æƒ…å ±åé›†', money:-2000, happy:5, tag:'learn'}
  ]},
  { m: '2å¹´ç›®9æœˆ', text: 'å¤§å‹å®¶é›»ã®è²·ã„æ›¿ãˆãŒå¿…è¦ã«', choices:[
    {label:'ã‚¨ã‚³å®¶é›»ã§é•·æœŸã‚³ã‚¹ãƒ‘ã‚’å„ªå…ˆ', money:-8000, happy:5, tag:'plan'},
    {label:'ä¸­å¤ã‚„ãƒªãƒ¼ã‚¹ã‚’æ´»ç”¨', money:-3000, happy:3, tag:'save'},
    {label:'è²·ã‚ãšã«ä¿®ç†ã‚’é¸ã¶', money:-1500, happy:1, tag:'save'}
  ]},
  { m: '2å¹´ç›®10æœˆ', text: 'ä»•äº‹ã«è»¢æ©Ÿã€‚å½¹è·ã‚„åƒãæ–¹ã‚’å†è¨­è¨ˆ', choices:[
    {label:'è²¬ä»»ã‚ã‚‹ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å¼•ãå—ã‘ã‚‹', money:7000, happy:4, tag:'side'},
    {label:'å­¦ã³ç›´ã—æœŸé–“ã‚’ç¢ºä¿', money:-5000, happy:6, tag:'learn'},
    {label:'åƒãæ–¹ã‚’è¦‹ç›´ã—ä½™ç™½ã‚’ä½œã‚‹', money:-2000, happy:8, tag:'rest'}
  ]},
  { m: '2å¹´ç›®11æœˆ', text: 'è³‡ç”£é˜²è¡›ã®ç‰¹åˆ¥ã‚»ãƒŸãƒŠãƒ¼', choices:[
    {label:'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚’è¨­è¨ˆ', money:2000, happy:4, tag:'protect'},
    {label:'ä¿¡è¨—ã‚„ç›¸ç¶šã®å°‚é–€å®¶ã«ç›¸è«‡', money:-4000, happy:3, tag:'plan'},
    {label:'è¦ç‚¹ã‚’ã¾ã¨ã‚ã¦å‚™å¿˜éŒ²', money:0, happy:2, tag:'learn'}
  ]},
  { m: '2å¹´ç›®12æœˆ', text: '2å¹´é–“ã®ç·æ‹¬ã¨æ¬¡ã®ãƒ“ã‚¸ãƒ§ãƒ³ä½œã‚Š', choices:[
    {label:'3å¹´ç›®ã®è³‡ç”£é…åˆ†ã¨ç›®æ¨™ã‚’è¨­è¨ˆ', money:0, happy:6, tag:'plan'},
    {label:'ãƒãƒ¼ãƒ ã‚„å®¶æ—ã¨ç¥ã†ãƒªãƒˆãƒªãƒ¼ãƒˆ', money:-9000, happy:18, tag:'joy'},
    {label:'2å¹´é–“ã®æˆæœã‚’noteã«ã¾ã¨ã‚ç™ºä¿¡', money:2000, happy:8, tag:'learn'}
  ]}
];

const START_MONEY = 50000;
const START_HAPPY = 50;
let turn = 0; // 0..11
let money = START_MONEY; // åˆæœŸæ‰€æŒé‡‘
let happy = START_HAPPY;
const tagPickCount = {}; // é¸æŠå‚¾å‘ã®é›†è¨ˆ
const monthHistory = [];
const reviewSchedule = [6, 12, 18, 24];
const completedReviews = new Set();
let reviewState = { active:false, onClose:null };
let introState = { active:false };
const completedQuizTurns = new Set();
let quizState = { active:false, onClose:null, quiz:null, answered:false };
let quizCycleIndexYear1 = 0;
let quizCycleIndexYear2 = 0;

function getChapterIndex(){
  const idx = Math.floor(Math.min(turn, monthlyEvents.length-1)/3);
  return Math.max(0, Math.min(chapterInfo.length-1, idx));
}

function updateChapterBanner(){
  const banner = document.getElementById('chapterBanner');
  if(!banner) return;
  const chapter = chapterInfo[getChapterIndex()];
  banner.innerHTML = `<div>${chapter.label}</div><small>${chapter.sub}</small>`;
}

function applySeasonTheme(){
  const theme = seasonThemes[getChapterIndex()] || seasonThemes[seasonThemes.length-1];
  document.body.style.background = theme.gradient;
  document.documentElement.style.setProperty('--accent', theme.accent);
  document.documentElement.style.setProperty('--accent-soft', theme.soft);
}

function calcProgress(value, max){
  if(max === 0) return 0;
  const pct = (value / max) * 100;
  return Math.max(0, Math.min(100, pct));
}

function updateMeters(){
  const moneyFill = document.getElementById('moneyFill');
  const happyFill = document.getElementById('happyFill');
  if(!moneyFill) return;
  moneyFill.style.width = calcProgress(money, 80000) + '%';
  happyFill.style.width = calcProgress(happy, 100) + '%';

  document.getElementById('moneyValue').textContent = `ï¿¥${money.toLocaleString()}`;
  document.getElementById('happyValue').textContent = `${happy} / 100`;
}

function renderBadges(){
  const shelf = document.getElementById('badgeShelf');
  if(!shelf) return;
  shelf.innerHTML = badgeCatalog.map(b => {
    const unlocked = unlockedBadges.has(b.id);
    return `
      <div class="badge ${unlocked ? 'unlocked' : ''}">
        <div class="badge-icon">${unlocked ? b.icon : 'ï¼Ÿ'}</div>
        <div class="badge-label">${unlocked ? b.title : 'ï¼Ÿï¼Ÿï¼Ÿ'}</div>
        <div style="font-size:11px; color:${unlocked ? '#a34f84' : '#aaa'};">
          ${unlocked ? b.desc : 'è§£æ”¾æ¡ä»¶ã‚’æ¢ã—ã¦ã¿ã‚ˆã†'}
        </div>
      </div>
    `;
  }).join('');
}

function unlockBadge(id){
  if(unlockedBadges.has(id)) return;
  const info = badgeCatalog.find(b => b.id === id);
  if(!info) return;
  unlockedBadges.add(id);
  renderBadges();
  showToast(`${info.icon} ${info.title}ã‚’ç²å¾—ï¼`);
}

function evaluateBadges(choice){
  if(choice && (choice.tag === 'invest' || choice.tag === 'overseas')){
    unlockBadge('investor');
  }
  if((tagPickCount.health || 0) >= 2){
    unlockBadge('wellness');
  }
  if((tagPickCount.plan || 0) + (tagPickCount.save || 0) >= 3){
    unlockBadge('planner');
  }
  if((tagPickCount.overseas || 0) >= 2){
    unlockBadge('globetrotter');
  }
  if(happy >= 70){
    unlockBadge('harmony');
  }
}

function addLogEntry(month, choice, delta){
  logEntries.unshift({
    month,
    choice,
    delta: { money: delta.money, happy: delta.happy }
  });
  if(logEntries.length > 6) logEntries.pop();
  renderLog();
}

function renderLog(){
  const log = document.getElementById('log');
  if(!log) return;
  const entries = logEntries.map(item => `
    <div class="log-entry">
      <div class="log-month">${item.month}</div>
      <div class="log-choice">${item.choice}</div>
      <div class="log-delta">${formatDelta(item.delta)}</div>
    </div>
  `).join('');
  log.innerHTML = `<div class="log-title">Decision Log</div>` + (entries || `<p style="margin:0; font-size:12px; color:#777;">ã¾ã é¸æŠãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`);
}

function formatDelta({money: m, happy: h}){
  const pieces = [];
  if(m) pieces.push(`ğŸ’µ ${m>0?'+':''}${m}`);
  if(h) pieces.push(`ğŸ’– ${h>0?'+':''}${h}`);
  return pieces.length ? pieces.join('<br>') : 'Â±0';
}

function showToast(message){
  const toast = document.getElementById('toast');
  if(!toast) return;
  toast.innerHTML = message;
  toast.classList.add('visible');
  clearTimeout(showToast.timer);
  showToast.timer = setTimeout(()=>toast.classList.remove('visible'), 2400);
}

function describeReward(reward){
  if(!reward) return '---';
  const pieces = [];
  if(reward.money) pieces.push(`ğŸ’µ ${reward.money>0?'+':''}${reward.money}`);
  if(reward.happy) pieces.push(`ğŸ’– ${reward.happy>0?'+':''}${reward.happy}`);
  return pieces.join(' / ') || '---';
}

function updateMissionBoard(){
  const board = document.getElementById('missionBoard');
  if(!board) return;
  if(!activeMission){
    board.classList.add('hidden');
    board.innerHTML = '';
    return;
  }
  board.classList.remove('hidden');
  const pct = Math.min(100, Math.round((activeMission.progress/activeMission.target)*100));
  const status = activeMission.completed ? 'CLEARED ğŸ‰' : 'é€²è¡Œä¸­';
  board.innerHTML = `
    <div class="mission-title">ğŸ¯ ${activeMission.title}</div>
    <div class="mission-desc">${activeMission.desc}</div>
    <div class="mission-progress">
      <span>${activeMission.progress}/${activeMission.target} steps</span>
      <span>${status}</span>
    </div>
    <div class="mission-progress-bar">
      <span class="mission-progress-fill" style="width:${pct}%"></span>
    </div>
    <div class="mission-tags">
      ${activeMission.tags.map(tag => `<span>${tagLabels[tag] || tag}</span>`).join('')}
    </div>
    <div class="mission-reward">å ±é…¬: ${describeReward(activeMission.reward)}</div>
  `;
}

function startMission(mission){
  if(!mission){
    activeMission = null;
    updateMissionBoard();
    return;
  }
  activeMission = { ...mission, progress:0, completed:false };
  updateMissionBoard();
  showToast(`ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: ${mission.title}`);
}

function applyMissionReward(reward){
  if(!reward) return;
  if(reward.money) money += reward.money;
  if(reward.happy) happy += reward.happy;
}

function handleMissionProgress(tag){
  if(!activeMission || activeMission.completed) return;
  if(!activeMission.tags.includes(tag)) return;
  activeMission.progress = Math.min(activeMission.target, activeMission.progress + 1);
  showToast(`ï¼‹1 ${activeMission.title}`);
  if(activeMission.progress >= activeMission.target){
    activeMission.completed = true;
    showToast(`âœ… ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢: ${activeMission.title}`);
    applyMissionReward(activeMission.reward);
  }
  updateMissionBoard();
}

function recordMonthHistory(entry){
  monthHistory.push(entry);
}

function shouldTriggerReview(currentTurn){
  return reviewSchedule.includes(currentTurn) && !completedReviews.has(currentTurn);
}

function shouldTriggerQuiz(currentTurn){
  if(currentTurn === 0) return false;
  return currentTurn % 3 === 0 && !completedQuizTurns.has(currentTurn);
}

function selectQuizForTurn(currentTurn){
  const isSecondYear = currentTurn > 12;
  const bank = isSecondYear ? seminarQuizBankYear2 : seminarQuizBankYear1;
  if(!bank.length) return null;
  if(isSecondYear){
    const quiz = bank[quizCycleIndexYear2 % bank.length];
    quizCycleIndexYear2++;
    return quiz;
  }
  const quiz = bank[quizCycleIndexYear1 % bank.length];
  quizCycleIndexYear1++;
  return quiz;
}

function computeHalfYearStats(endTurn){
  const blockSize = 6;
  const startTurn = Math.max(0, endTurn - blockSize);
  const entries = monthHistory.filter(e => e.turnIndex >= startTurn && e.turnIndex < endTurn);
  const prevEntry = monthHistory.find(e => e.turnIndex === startTurn - 1);
  const startMoney = startTurn === 0 ? START_MONEY : (prevEntry ? prevEntry.afterMoney : START_MONEY);
  const startHappy = startTurn === 0 ? START_HAPPY : (prevEntry ? prevEntry.afterHappy : START_HAPPY);
  const endEntry = monthHistory.find(e => e.turnIndex === endTurn - 1);
  const endMoney = endEntry ? endEntry.afterMoney : money;
  const endHappy = endEntry ? endEntry.afterHappy : happy;
  const moneyChange = endMoney - startMoney;
  const happyChange = endHappy - startHappy;
  const avgHappy = entries.length ? Math.round(entries.reduce((sum,e)=>sum+e.afterHappy,0)/entries.length) : endHappy;
  const tagCounts = {};
  entries.forEach(e => {
    if(!e.tag) return;
    tagCounts[e.tag] = (tagCounts[e.tag] || 0) + 1;
  });
  const topTags = Object.entries(tagCounts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(([tag,count]) => `${tagLabels[tag] || tag}Ã—${count}`);
  return {
    startTurn,
    endTurn,
    startMoney,
    endMoney,
    startHappy,
    endHappy,
    moneyChange,
    happyChange,
    avgHappy,
    tagCounts,
    topTags,
    entries
  };
}

function formatSigned(value){
  if(value === 0) return 'Â±0';
  return `${value>0?'+':''}${value}`;
}

function buildReviewHighlights(stats){
  const highlights = [];
  highlights.push(`ğŸ’µ ï¿¥${stats.startMoney.toLocaleString()} â†’ ï¿¥${stats.endMoney.toLocaleString()}ï¼ˆ${formatSigned(stats.moneyChange)}å††ï¼‰`);
  highlights.push(`ğŸ’– ${stats.startHappy} â†’ ${stats.endHappy}ï¼ˆ${formatSigned(stats.happyChange)}ï¼‰ï¼å¹³å‡ ${stats.avgHappy}`);
  if(stats.topTags.length){
    highlights.push(`ğŸ§­ ã‚ˆãé¸ã‚“ã ãƒ†ãƒ¼ãƒï¼š${stats.topTags.join(' / ')}`);
  } else {
    highlights.push('ğŸ§­ è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ãŸã‚æ¬¡æœŸã«æ³¨ç›®ã€‚');
  }
  return highlights;
}

function buildToughFeedback(stats){
  const coachName = selectedCoach ? selectedCoach.name : 'ã‚³ãƒ¼ãƒ';
  const comments = [];
  const moneyGap = goalPlan ? goalPlan.money - stats.endMoney : null;
  const happyGap = goalPlan ? goalPlan.happy - stats.endHappy : null;
  if(stats.moneyChange < 0){
    comments.push(`${coachName}ã€Œç¾é‡‘ãŒ${Math.abs(stats.moneyChange).toLocaleString()}å††æ¸›ã£ãŸã¾ã¾ã€‚æµªè²»ã‚’â€œã‚¤ãƒ™ãƒ³ãƒˆâ€åŒ–ã—ãªã„ã¨ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã‚ˆã€‚ã€`);
  } else if(moneyGap !== null && moneyGap > 10000){
    comments.push(`${coachName}ã€Œç›®æ¨™ã¨ã®å·®ãŒï¿¥${moneyGap.toLocaleString()}ã€‚æ•°å­—ã‚’ç›´è¦–ã—ã¦æ”»ã‚æ–¹ã‚’ä¿®æ­£ã—ã‚ˆã†ã€‚ã€`);
  }
  if(stats.avgHappy < 60){
    comments.push(`${coachName}ã€Œå¹¸ç¦åº¦ã®å¹³å‡ãŒ${stats.avgHappy}ã€‚ä¼‘æ¯ã‚‚ã”è¤’ç¾ã‚‚â€œè¨ˆç”»â€ã«è½ã¨ã—è¾¼ã‚ã¦ã„ãªã„è¨¼æ‹ ã€‚ã€`);
  } else if(happyGap !== null && happyGap > 5){
    comments.push(`${coachName}ã€Œå¹¸ç¦åº¦ãŒç›®æ¨™ã‚ˆã‚Š${happyGap}ãƒã‚¤ãƒ³ãƒˆä½ã„ã€‚ã‚¹ãƒˆãƒ¬ã‚¹æºã‚’æ´—ã„å‡ºã—ã¦ã€‚ã€`);
  }
  if(Object.keys(stats.tagCounts).length < 3){
    comments.push(`${coachName}ã€Œé¸æŠãŒåã‚Šã™ãã€‚é•ã†ãƒ†ãƒ¼ãƒã‚’æ•¢ãˆã¦å…¥ã‚Œã¦çµŒé¨“å€¤ã‚’å¢—ã‚„ãã†ã€‚ã€`);
  }
  const investActions = (stats.tagCounts.invest || 0) + (stats.tagCounts.overseas || 0);
  if(investActions === 0){
    comments.push(`${coachName}ã€ŒæŠ•è³‡ã‚„æµ·å¤–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¼ãƒ­ã€‚æƒ…å ±åé›†ã ã‘ã§æº€è¶³ã—ã¦ã„ãªã„ï¼Ÿã€`);
  }
  const protectActions = (stats.tagCounts.protect || 0) + (stats.tagCounts.rebalance || 0);
  if(protectActions === 0){
    comments.push(`${coachName}ã€Œå®ˆã‚Šãƒ»ç‚¹æ¤œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹å½“ãŸã‚‰ãªã„ã€‚æºã‚‰ãè€æ€§ãŒã‚¼ãƒ­ã«ãªã‚‹ã‚ˆã€‚ã€`);
  }
  if(!comments.length){
    comments.push(`${coachName}ã€Œæ‚ªãã¯ãªã„ã€‚ã§ã‚‚ã“ã®ãƒšãƒ¼ã‚¹ã§ã¯â€œæ™®é€šâ€ã§çµ‚ã‚ã‚‹ã€‚æ•°å­—ã¨ç¿’æ…£ã‚’ã‚‚ã†ä¸€æ®µã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã‚ˆã†ã€‚ã€`);
  }
  return comments.slice(0,3);
}

function blockLabel(startTurn, endTurn){
  const startLabel = monthlyEvents[startTurn]?.m || '---';
  const endLabel = monthlyEvents[endTurn-1]?.m || '---';
  return `${startLabel}ã€œ${endLabel}`;
}

function openHalfYearReview(endTurn, onClose){
  const overlay = document.getElementById('reviewOverlay');
  if(!overlay){
    if(typeof onClose === 'function'){ onClose(); }
    return;
  }
  const stats = computeHalfYearStats(endTurn);
  completedReviews.add(endTurn);
  const titleEl = document.getElementById('reviewTitle');
  const subtitleEl = document.getElementById('reviewSubtitle');
  const moneySummary = document.getElementById('reviewMoneySummary');
  const happySummary = document.getElementById('reviewHappySummary');
  const tagSummary = document.getElementById('reviewTagSummary');
  const highlightList = document.getElementById('reviewHighlightList');
  const feedbackBox = document.getElementById('reviewFeedbackBox');
  const label = blockLabel(stats.startTurn, stats.endTurn);
  if(titleEl){ titleEl.textContent = `${label}ãƒ¬ãƒ“ãƒ¥ãƒ¼`; }
  if(subtitleEl){ subtitleEl.textContent = `${Math.ceil(stats.endTurn/6)}æœŸç›®ã®ã‚³ãƒ¼ãƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯`; }
  if(moneySummary){
    moneySummary.textContent = `ï¿¥${stats.startMoney.toLocaleString()} â†’ ï¿¥${stats.endMoney.toLocaleString()}`;
  }
  if(happySummary){
    happySummary.textContent = `${stats.startHappy} â†’ ${stats.endHappy} / Avg ${stats.avgHappy}`;
  }
  if(tagSummary){
    tagSummary.textContent = stats.topTags[0] || 'ãƒ‡ãƒ¼ã‚¿ä¸è¶³';
  }
  const highlights = buildReviewHighlights(stats);
  if(highlightList){
    highlightList.innerHTML = highlights.map(item => `<li>${item}</li>`).join('');
  }
  const critiques = buildToughFeedback(stats);
  if(feedbackBox){
    feedbackBox.innerHTML = `<strong>å³ã—ã„æŒ‡æ‘˜</strong><br>${critiques.join('<br>')}`;
  }
  overlay.classList.add('visible');
  reviewState = { active:true, onClose };
}

function closeHalfYearReview(){
  if(!reviewState.active) return;
  const overlay = document.getElementById('reviewOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  const cb = reviewState.onClose;
  reviewState = { active:false, onClose:null };
  if(typeof cb === 'function'){ cb(); }
}

function openCoachIntro(){
  const overlay = document.getElementById('coachIntroOverlay');
  if(!overlay){ openGoalSetting(); return; }
  const coachNameEl = document.getElementById('coachIntroName');
  const coachDescEl = document.getElementById('coachIntroDesc');
  const coachOpeningEl = document.getElementById('coachIntroOpening');
  const coachAvatarEl = document.getElementById('coachIntroAvatar');
  const pointsEl = document.getElementById('coachIntroPoints');
  if(coachAvatarEl){ coachAvatarEl.src = selectedCoach?.avatarSrc || ''; }
  if(coachNameEl){ coachNameEl.textContent = `${selectedCoach?.name || 'ã‚³ãƒ¼ãƒ'} ã®è‡ªå·±ç´¹ä»‹`; }
  if(coachDescEl){ coachDescEl.textContent = selectedCoach?.desc || ''; }
  if(coachOpeningEl){
    coachOpeningEl.innerHTML = `${selectedCoach?.name || 'ã‚³ãƒ¼ãƒ'}ã€Œã“ã‚Œã‹ã‚‰1å¹´ã€æ‰€æŒé‡‘ã¨å¹¸ç¦åº¦ã®2æœ¬æŸ±ã‚’ä¸€ç·’ã«æ•´ãˆã‚‹ã‚ˆã€‚æ•°å­—ã ã‘ã§ãªãã€ã©ã†æ„Ÿã˜ã¦å‹•ãã‹ã‚’æ¯æœˆæŒ¯ã‚Šè¿”ã‚ã†ã€‚ã€`;
  }
  if(pointsEl){
    pointsEl.innerHTML = statImportance.map(point => `
      <li>
        <h4>${point.title}</h4>
        <p style="margin:0;">${point.text}</p>
      </li>
    `).join('');
  }
  overlay.classList.add('visible');
  introState = { active:true };
  showCoach('plan', 'ã¾ãšã¯ç§ã®è‡ªå·±ç´¹ä»‹ã¨ã€æ‰€æŒé‡‘ï¼†å¹¸ç¦åº¦ã‚’ç®¡ç†ã™ã‚‹æ„å‘³ã‹ã‚‰è©±ãã†ã€‚');
}

function closeCoachIntro(){
  if(!introState.active){
    openGoalSetting();
    return;
  }
  const overlay = document.getElementById('coachIntroOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  introState = { active:false };
  openGoalSetting();
}

function openSeminarQuiz(currentTurn, onClose){
  const overlay = document.getElementById('quizOverlay');
  if(!overlay){
    if(typeof onClose === 'function'){ onClose(); }
    return;
  }
  const quiz = selectQuizForTurn(currentTurn);
  if(!quiz){
    if(typeof onClose === 'function'){ onClose(); }
    return;
  }
  const titleEl = document.getElementById('quizTitle');
  const questionEl = document.getElementById('quizQuestion');
  const optionsEl = document.getElementById('quizOptions');
  const feedbackEl = document.getElementById('quizFeedback');
  const continueBtn = document.getElementById('quizContinue');
  completedQuizTurns.add(currentTurn);
  quizState = { active:true, onClose, quiz, answered:false };
  if(titleEl){ titleEl.textContent = quiz.title; }
  if(questionEl){ questionEl.textContent = quiz.question; }
  if(feedbackEl){ feedbackEl.textContent = ''; }
  if(continueBtn){
    continueBtn.disabled = true;
  }
  if(optionsEl){
    optionsEl.innerHTML = '';
    quiz.choices.forEach((choice, idx) => {
      const btn = document.createElement('button');
      btn.textContent = choice.label;
      btn.addEventListener('click', () => answerSeminarQuiz(idx));
      optionsEl.appendChild(btn);
    });
  }
  overlay.classList.add('visible');
  showCoach('learn', 'ã‚»ãƒŸãƒŠãƒ¼å¾©ç¿’ã‚¯ã‚¤ã‚ºã§ç†è§£åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ã€‚æ­£è§£ã™ã‚Œã°å¹¸ç¦åº¦ãƒœãƒ¼ãƒŠã‚¹ï¼');
}

function answerSeminarQuiz(choiceIndex){
  if(!quizState.active || quizState.answered) return;
  const overlay = document.getElementById('quizOverlay');
  const optionsEl = document.getElementById('quizOptions');
  const feedbackEl = document.getElementById('quizFeedback');
  const continueBtn = document.getElementById('quizContinue');
  const quiz = quizState.quiz;
  const choice = quiz?.choices?.[choiceIndex];
  if(!choice || !optionsEl) return;
  quizState.answered = true;
  const buttons = Array.from(optionsEl.querySelectorAll('button'));
  buttons.forEach((btn, idx) => {
    btn.disabled = true;
    if(quiz.choices[idx].correct){
      btn.classList.add('correct');
    } else if(idx === choiceIndex){
      btn.classList.add('incorrect');
    }
  });
  const delta = choice.happy || 0;
  happy += delta;
  updateStatus();
  const coachLine = choice.correct
    ? `${selectedCoach?.name || 'ã‚³ãƒ¼ãƒ'}ã€Œã„ã„ã­ï¼ç†è§£ãŒæ·±ã¾ã‚‹ã¨è¡Œå‹•é€Ÿåº¦ã‚‚ä¸ŠãŒã‚‹ã‚ˆã€‚ã€`
    : `${selectedCoach?.name || 'ã‚³ãƒ¼ãƒ'}ã€Œã“ã“ã¯æŠ¼ã•ãˆã¦ãŠããŸã„åŸºç¤ã€‚æ¬¡ã‹ã‚‰ã¯ç­”ãˆã‚’è¦‹ãšã«èª¬æ˜ã§ãã‚‹ã‹ç¢ºèªã—ã‚ˆã†ã€‚ã€`;
  showCoach('learn', coachLine);
  if(feedbackEl){
    const explanation = quiz.explanation ? `<br>${quiz.explanation}` : '';
    feedbackEl.innerHTML = `${choice.feedback}${explanation}<br>ä»Šå›ã®å¹¸ç¦åº¦å¤‰åŒ–ï¼š${delta>0?'+':''}${delta}`;
  }
  if(continueBtn){
    continueBtn.disabled = false;
  }
}

function closeSeminarQuiz(){
  if(!quizState.active) return;
  const overlay = document.getElementById('quizOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  const cb = quizState.onClose;
  quizState = { active:false, onClose:null, quiz:null, answered:false };
  if(typeof cb === 'function'){ cb(); }
}

const goalQuestions = [
  {
    id: 'buffer',
    title: 'å®ˆã‚Šã®åšã•ã‚’æ±ºã‚ã‚ˆã†',
    text: 'ç”Ÿæ´»è²»ã®ä½•ã‹æœˆåˆ†ã‚’ç¾é‡‘ã§ã‚­ãƒ¼ãƒ—ã§ãã‚‹ã¨å®‰å¿ƒï¼Ÿæ”¯å‡ºã‚„å®¶æ—æ§‹æˆã¨ç…§ã‚‰ã—ã¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚',
    intro: 'å®ˆã‚ŠãŒåšã„ã»ã©æ—¥ã€…ã®å®‰å¿ƒæ„ŸãŒå¢—ã™åˆ†ã€æ”»ã‚ã®è³‡é‡‘ã¯ã‚†ã£ãã‚Šè‚²ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã‚ˆã€‚',
    options: [
      {
        value: 'lean',
        label: '3ã‹æœˆåˆ†ã§OKã€‚æ©Ÿå‹•åŠ›å„ªå…ˆ',
        detail: 'å›ºå®šè²»ã¯ã‚¹ãƒªãƒ ã€‚ç¾é‡‘ã‚’çµã£ã¦æŒ‘æˆ¦ã¸å›ã™',
        effect: { money: -6000, happy: 2 },
        summary: 'æ©Ÿå‹•åŠ›é‡è¦–ã§ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã¯è–„ã‚ã«ã€‚',
        coach: 'æ”»ã‚ã‚’å„ªå…ˆã™ã‚‹ãªã‚‰ç¾é‡‘ã‚’å¿…è¦æœ€å°é™ã«ã€‚ä»£ã‚ã‚Šã«ä½“èª¿ç®¡ç†ã¨æƒ…å ±åé›†ã¯æ€ ã‚‰ãªã„ã§ã€‚'
      },
      {
        value: 'standard',
        label: '4ã€œ5ã‹æœˆåˆ†ã‚’ã‚­ãƒ¼ãƒ—',
        detail: 'å®ˆã‚Šã¨æ”»ã‚ã‚’åŠã€…ã«ã€‚',
        effect: { money: 0, happy: 0 },
        summary: 'æ¨™æº–çš„ãªé˜²è¡›ãƒ©ã‚¤ãƒ³ã§ãƒãƒ©ãƒ³ã‚¹å‹ã€‚',
        coach: 'åœ°ã«è¶³ã‚’ã¤ã‘ãŸçŠ¶æ…‹ã§æŒ‘æˆ¦ã§ãã‚‹ãƒãƒ©ãƒ³ã‚¹ã€‚æš®ã‚‰ã—ã®å¤‰å‹•ã«ã‚‚è½ã¡ç€ã„ã¦å¯¾å¿œã§ãã‚‹ã­ã€‚'
      },
      {
        value: 'solid',
        label: '6ã‹æœˆä»¥ä¸Šã¯æ¬²ã—ã„',
        detail: 'å®¶æ—ãƒ»ä»•äº‹ã®äº‹æƒ…ã§å®ˆã‚Šåšã‚',
        effect: { money: 9000, happy: -2 },
        summary: 'å®ˆã‚Šã‚’åšãã—ã¦å¿ƒã‚’è½ã¡ç€ã‹ã›ã‚‹ã€‚',
        coach: 'ä¸€æ™‚çš„ã«å¹¸ç¦åº¦ãŒä¸‹ãŒã£ã¦ã‚‚ã€å®‰å¿ƒææ–™ã‚’ç©ã‚“ã§ãŠã‘ã°å¤§ããå´©ã‚Œãªã„ã€‚'
      }
    ]
  },
  {
    id: 'challenge',
    title: 'ä»Šå¹´ã®æŒ‘æˆ¦ãƒ¬ãƒ™ãƒ«ã¯ï¼Ÿ',
    text: 'å‰¯æ¥­ã‚„æŠ•è³‡ãªã©ã€æ–°ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ã‚®ã‚¢ã‚’ã©ã“ã¾ã§ä¸Šã’ãŸã„ï¼Ÿ',
    intro: 'æ”»ã‚ã‚‹ã»ã©æº–å‚™è³‡é‡‘ã¨å¿ƒã®ä½™ç™½ã®ä¸¡æ–¹ãŒå¿…è¦ã«ãªã‚‹ã‚ˆã€‚',
    options: [
      {
        value: 'calm',
        label: 'æ•´ãˆã‚‹å¹´ã€‚ç¾çŠ¶ã‚’ç£¨ã',
        detail: 'å®šç€ã«é›†ä¸­ã—ç„¡ç†ã¯ã—ãªã„',
        effect: { money: 0, happy: 2 },
        summary: 'æ•´ãˆå„ªå…ˆã§å®‰å®šé‡è¦–ã€‚',
        coach: 'ã¾ãšã¯ä»•çµ„ã¿åŒ–ã¨ç¿’æ…£åŒ–ã€‚ä¼¸ã³ã—ã‚ã‚ˆã‚Šå†ç¾æ€§ã‚’ç£¨ã“ã†ã€‚'
      },
      {
        value: 'medium',
        label: 'å°ã•ã2ã€œ3å€‹æŒ‘æˆ¦',
        detail: 'å‰¯æ¥­ã‚„å­¦ã³ã‚’å°‘ã—å¢—ã‚„ã™',
        effect: { money: 3000, happy: 3 },
        summary: 'è¡Œå‹•é‡ã‚’å¢—ã‚„ã—ã¦çµŒé¨“å€¤ã‚’ç©ã‚€ã€‚',
        coach: 'å°ã•ãå§‹ã‚ã¦æ¤œè¨¼ã™ã‚Œã°ã€æ•°å­—ã‚‚å¿ƒã‚‚æ•´ãˆãªãŒã‚‰ã‚®ã‚¢ã‚’ä¸Šã’ã‚‰ã‚Œã‚‹ã‚ˆã€‚'
      },
      {
        value: 'bold',
        label: 'ä¸€æ°—ã«æ”»ã‚ã‚‹',
        detail: 'å‰¯æ¥­ã‚„æŠ•è³‡ã‚’ãã£ã¨æ‹¡å¼µ',
        effect: { money: 7000, happy: 5 },
        summary: 'æ”»ã‚ã®ã‚®ã‚¢ã‚’å…¥ã‚Œã¦ä¼¸ã³ã—ã‚ã‚’ç‹™ã†ã€‚',
        coach: 'æŒ‘æˆ¦ãŒå¢—ãˆã‚‹ã»ã©ã‚³ã‚¹ãƒˆã‚„æ„Ÿæƒ…ã®æºã‚Œã‚‚å¢—ãˆã‚‹ã€‚è³‡é‡‘ã¨ã”è¤’ç¾ã®ä¸¡æ–¹ã‚’è¨­è¨ˆã—ã¦ã„ã“ã†ã€‚'
      }
    ]
  },
  {
    id: 'wellbeing',
    title: 'å¿ƒã®ä½™ç™½ã¯ã©ã®ãã‚‰ã„ï¼Ÿ',
    text: 'å¹¸ç¦åº¦ã‚’ã‚­ãƒ¼ãƒ—ã™ã‚‹ãŸã‚ã®ä¼‘æ¯ã‚„è‡ªå·±æŠ•è³‡ã‚’ã©ã†æ‰±ã„ãŸã„ï¼Ÿ',
    intro: 'ä½™ç™½ã‚’åšãã™ã‚‹ã¨åˆ¤æ–­åŠ›ã‚‚å›å¾©ã—ã‚„ã™ã„ã€‚é€†ã«å‰Šã‚Œã°ã‚¹ãƒ”ãƒ¼ãƒ‰ã¯å‡ºã‚‹ã‘ã‚Œã©ç–²ã‚Œã‚„ã™ã„ã€‚',
    options: [
      {
        value: 'focus',
        label: 'åŠ¹ç‡é‡è¦–ã€‚ã‚„ã‚‹ã“ã¨ã«é›†ä¸­',
        detail: 'å¿…è¦æœ€ä½é™ã ã‘ä¼‘ã‚€',
        effect: { money: 0, happy: -3 },
        summary: 'é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã§åŠ¹ç‡å„ªå…ˆã€‚',
        coach: 'é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¯å¼·ã„ã‘ã©ã€ç–²ã‚Œã‚’ç¿Œæœˆã«æŒã¡è¶Šã•ãªã„ä»•çµ„ã¿ã‚’ã¤ãã‚ã†ã€‚'
      },
      {
        value: 'balanced',
        label: 'ãƒãƒ©ãƒ³ã‚¹ã‚ˆãä½™ç™½ã‚‚äºˆå®šåŒ–',
        detail: 'æœˆ1ã®ã”è¤’ç¾ã‚„ãƒ¡ãƒ³ãƒ†',
        effect: { money: 0, happy: 2 },
        summary: 'æ•´ãˆã‚‹Ã—æ”»ã‚ã‚‹ã‚’ä¸¡ç«‹ã€‚',
        coach: 'ä½™ç™½ã‚’äºˆå®šã«å…¥ã‚Œã‚‹ã¨è‡ªå·±ç®¡ç†ã®ç²¾åº¦ãŒä¸ŠãŒã‚‹ã‚ˆã€‚'
      },
      {
        value: 'lush',
        label: 'ä½™ç™½ãŸã£ã·ã‚Šã€‚å†…é¢ã‚±ã‚¢æœ€å„ªå…ˆ',
        detail: 'ã”è¤’ç¾ã‚„ä¼‘æš‡ã‚’ã—ã£ã‹ã‚Šç¢ºä¿',
        effect: { money: -2000, happy: 6 },
        summary: 'å¹¸ç¦åº¦ã‚’æœ€å„ªå…ˆã«æ¸©ã‹ãéã”ã™ã€‚',
        coach: 'å¿ƒã®ä½™ç™½ã‚’åšãã™ã‚‹ã¨æ„æ€æ±ºå®šã‚‚å†´ãˆã‚‹ã€‚æŠ•è³‡ã‚ˆã‚Šå…ˆã«è‡ªåˆ†ã‚’æº€ãŸãã†ã€‚'
      }
    ]
  }
];

let goalWizard = null;

function goalDefaults(){
  return { money: 80000, happy: 80 };
}

function sanitizeGoalPlan(plan){
  const defaults = goalDefaults();
  const sanitized = {
    money: Number.isFinite(plan?.money) ? plan.money : defaults.money,
    happy: Number.isFinite(plan?.happy) ? plan.happy : defaults.happy
  };
  sanitized.money = Math.max(50000, Math.min(150000, Math.round(sanitized.money / 1000) * 1000));
  sanitized.happy = Math.max(55, Math.min(95, Math.round(sanitized.happy)));
  return sanitized;
}

function resetGoalWizard(){
  goalWizard = {
    step: 0,
    answers: {},
    proposal: goalDefaults()
  };
}

function computeGoalProposal(){
  if(!goalWizard){
    return goalDefaults();
  }
  const draft = { ...goalDefaults() };
  goalQuestions.forEach(q => {
    const answer = goalWizard.answers[q.id];
    const opt = q.options.find(o => o.value === answer);
    if(opt && opt.effect){
      if(typeof opt.effect.money === 'number'){ draft.money += opt.effect.money; }
      if(typeof opt.effect.happy === 'number'){ draft.happy += opt.effect.happy; }
    }
  });
  goalWizard.proposal = sanitizeGoalPlan(draft);
  return goalWizard.proposal;
}

function updateGoalCoachNote(question){
  const noteEl = document.getElementById('goalCoachNote');
  if(!noteEl || !question) return;
  const coachName = selectedCoach ? selectedCoach.name : 'ã‚³ãƒ¼ãƒ';
  const answer = goalWizard?.answers[question.id];
  if(answer){
    const opt = question.options.find(o => o.value === answer);
    noteEl.innerHTML = `<strong>${coachName}ã®ã‚³ãƒ¡ãƒ³ãƒˆ</strong><div>${opt?.coach || 'ã„ã„ã­ã€ãã®æ„Ÿè¦šã§ã„ã“ã†ã€‚'}</div>`;
  } else {
    noteEl.innerHTML = `<strong>${coachName}ã‹ã‚‰ã®ãƒ’ãƒ³ãƒˆ</strong><div>${question.intro}</div>`;
  }
}

function renderGoalQuestion(){
  if(!goalWizard) return;
  const question = goalQuestions[goalWizard.step];
  if(!question){
    goToGoalSummary();
    return;
  }
  setGoalModalView('question');
  const titleEl = document.getElementById('goalQuestionTitle');
  const textEl = document.getElementById('goalQuestionText');
  const optionsWrap = document.getElementById('goalOptions');
  if(titleEl){ titleEl.textContent = `${goalWizard.step + 1}. ${question.title}`; }
  if(textEl){ textEl.textContent = question.text; }
  if(optionsWrap){
    optionsWrap.innerHTML = '';
    question.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.innerHTML = `<strong>${opt.label}</strong><br><small>${opt.detail}</small>`;
      if(goalWizard.answers[question.id] === opt.value){
        btn.classList.add('selected');
      }
      btn.addEventListener('click', () => {
        goalWizard.answers[question.id] = opt.value;
        computeGoalProposal();
        renderGoalQuestion();
      });
      optionsWrap.appendChild(btn);
    });
  }
  updateGoalCoachNote(question);
  updateGoalWizardButtons();
}

function updateGoalWizardButtons(){
  const backBtn = document.getElementById('goalBackStep');
  const nextBtn = document.getElementById('goalNextStep');
  const question = goalQuestions[goalWizard?.step || 0];
  const answered = question ? goalWizard?.answers[question.id] : null;
  if(backBtn){ backBtn.disabled = !goalWizard || goalWizard.step === 0; }
  if(nextBtn){
    nextBtn.textContent = (goalWizard && goalWizard.step === goalQuestions.length - 1) ? 'ææ¡ˆã‚’è¦‹ã‚‹' : 'æ¬¡ã¸';
    nextBtn.disabled = !answered;
  }
}

function advanceGoalWizard(){
  if(!goalWizard) return;
  const question = goalQuestions[goalWizard.step];
  if(question && !goalWizard.answers[question.id]){
    showToast('1ã¤é¸ã‚“ã§ã‹ã‚‰é€²ã‚‚ã†ã€‚');
    return;
  }
  if(goalWizard.step < goalQuestions.length - 1){
    goalWizard.step++;
    renderGoalQuestion();
  } else {
    goToGoalSummary();
  }
}

function rewindGoalWizard(){
  if(!goalWizard || goalWizard.step === 0) return;
  goalWizard.step--;
  renderGoalQuestion();
}

function renderGoalSummary(){
  const summaryBox = document.getElementById('goalSummaryView');
  if(!summaryBox) return;
  const plan = goalWizard?.proposal || computeGoalProposal();
  const coachName = selectedCoach ? selectedCoach.name : 'ã‚³ãƒ¼ãƒ';
  const answerTags = goalQuestions.map(q => {
    const opt = q.options.find(o => o.value === goalWizard?.answers[q.id]);
    return opt ? `<li>${opt.label}</li>` : '';
  }).filter(Boolean).join('') || '<li>æ¨™æº–ãƒ—ãƒ©ãƒ³</li>';
  const message = goalQuestions.map(q => {
    const opt = q.options.find(o => o.value === goalWizard?.answers[q.id]);
    return opt?.summary;
  }).filter(Boolean).join('ï¼') || 'åŸºæº–ãƒ©ã‚¤ãƒ³ã§æ•´ãˆã¦ã‹ã‚‰é€²ã‚‚ã†ã€‚';
  summaryBox.innerHTML = `
    <h4>${coachName}ã®ææ¡ˆ</h4>
    <ul class="goal-summary-list">
      <li>ğŸ’µ æ‰€æŒé‡‘ï¼šï¿¥${plan.money.toLocaleString()}</li>
      <li>ğŸ’– å¹¸ç¦åº¦ï¼š${plan.happy}</li>
    </ul>
    <p style="font-size:13px; color:#6b3f52; margin:6px 0;">${coachName}ã€Œ${message}ã€</p>
    <ul class="goal-tags">${answerTags}</ul>
  `;
}

function goToGoalSummary(){
  computeGoalProposal();
  renderGoalSummary();
  setGoalModalView('summary');
}

function setGoalModalView(view){
  const conversation = document.getElementById('goalConversation');
  const summary = document.getElementById('goalSummaryView');
  const manual = document.getElementById('goalManualForm');
  const wizardActions = document.getElementById('goalWizardActions');
  const summaryActions = document.getElementById('goalSummaryActions');
  const manualActions = document.getElementById('goalManualActions');
  if(conversation){ conversation.classList.toggle('hidden', view !== 'question'); }
  if(summary){ summary.classList.toggle('hidden', view !== 'summary'); }
  if(manual){ manual.classList.toggle('hidden', view !== 'manual'); }
  if(wizardActions){ wizardActions.classList.toggle('hidden', view !== 'question'); }
  if(summaryActions){ summaryActions.classList.toggle('hidden', view !== 'summary'); }
  if(manualActions){ manualActions.classList.toggle('hidden', view !== 'manual'); }
}

function startGoalManualEdit(){
  const plan = goalWizard?.proposal || computeGoalProposal();
  const moneyInput = document.getElementById('manualGoalMoney');
  const happyInput = document.getElementById('manualGoalHappy');
  if(moneyInput){ moneyInput.value = plan.money; }
  if(happyInput){ happyInput.value = plan.happy; }
  setGoalModalView('manual');
}

function backToGoalSummary(){
  setGoalModalView('summary');
}

function updateGoalIndicator(){
  const box = document.getElementById('goalIndicator');
  if(!box) return;
  if(!goalPlan){
    box.classList.add('hidden');
    box.innerHTML = '';
    return;
  }
  const diffMoney = goalPlan.money - money;
  const diffHappy = goalPlan.happy - happy;
  const describe = diff => diff <= 0 ? 'é”æˆï¼' : `ã‚ã¨ ${diff}`;
  box.classList.remove('hidden');
  box.innerHTML = `
    <strong>ã‚³ãƒ¼ãƒã¨ç«‹ã¦ãŸç›®æ¨™</strong>
    <div class="goal-progress-row"><span>ğŸ’µ ï¿¥${goalPlan.money.toLocaleString()}</span><span>${describe(diffMoney)}</span></div>
    <div class="goal-progress-row"><span>ğŸ’– ${goalPlan.happy}</span><span>${describe(diffHappy)}</span></div>
  `;
}

function openGoalSetting(){
  const overlay = document.getElementById('goalOverlay');
  if(!overlay) return;
  resetGoalWizard();
  renderGoalQuestion();
  overlay.classList.add('visible');
  showCoach('plan', 'æ‰€æŒé‡‘ã¯å®ˆã‚Šã¨æŒ‘æˆ¦ã®ç‡ƒæ–™ã€å¹¸ç¦åº¦ã¯æ±ºæ–­åŠ›ã®æºã€‚æ•°å­—ã§ç´„æŸã—ã¦ã‹ã‚‰å†’é™ºã‚’å§‹ã‚ã‚ˆã†ã€‚');
}

function closeGoalSetting(){
  const overlay = document.getElementById('goalOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
}

function confirmGoalSetting(skip=false, planOverride=null){
  if(skip){
    goalPlan = goalDefaults();
  } else {
    const normalized = sanitizeGoalPlan(planOverride || goalWizard?.proposal || goalDefaults());
    goalPlan = normalized;
  }
  closeGoalSetting();
  updateGoalIndicator();
  showCoach('plan', 'ã„ã„ç›®æ¨™ãŒæã‘ãŸã­ã€‚æ¯æœˆä¸€ç·’ã«æŒ¯ã‚Šè¿”ã‚ã†ï¼');
  nextEvent();
}

function describeChoiceDeltaText(choice){
  const pieces = [];
  if(choice.money) pieces.push(`ğŸ’µ ${choice.money>0?'+':''}${choice.money}`);
  if(choice.happy) pieces.push(`ğŸ’– ${choice.happy>0?'+':''}${choice.happy}`);
  return pieces.length ? pieces.join(' / ') : 'å¤‰åŒ–ãªã—';
}

function getToughLoveMessage(choice){
  const coachName = selectedCoach ? selectedCoach.name : 'ã‚³ãƒ¼ãƒ';
  const moneyGap = goalPlan ? goalPlan.money - money : null;
  const happyGap = goalPlan ? goalPlan.happy - happy : null;
  if(choice.money < 0 && moneyGap !== null && moneyGap > 8000){
    return `${coachName}ã€Œæ”¯å‡ºãŒå¢—ãˆã¦ç›®æ¨™ã¨ã®å·®ãŒ${moneyGap.toLocaleString()}å††ã«åºƒãŒã£ã¦ã‚‹ã‚ˆã€‚æ•°å­—ã‚’ç›´è¦–ã—ã¦ç«‹ã¦ç›´ãã†ã€‚ã€`;
  }
  if(happy < 40){
    return `${coachName}ã€Œå¹¸ç¦åº¦ãŒ40ã‚’ä¸‹å›ã£ã¦ã„ã‚‹ã‚ã€‚ä¼‘æ¯ã‚„ã”è¤’ç¾ã‚’è¨ˆç”»ã«çµ„ã¿è¾¼ã¾ãªã„ã¨ã€åˆ¤æ–­ãŒç²—ããªã‚‹ã€‚ã€`;
  }
  if(happyGap !== null && happyGap > 10){
    return `${coachName}ã€Œç›®æ¨™ã®å¹¸ç¦åº¦ã‚ˆã‚Š${happyGap}ãƒã‚¤ãƒ³ãƒˆä½ã„ã­ã€‚ä½•ã‚’å‰Šã£ãŸã®ã‹æŒ¯ã‚Šè¿”ã£ã¦ã€‚ã€`;
  }
  if(money < 20000){
    return `${coachName}ã€Œç¾é‡‘ã‚¯ãƒƒã‚·ãƒ§ãƒ³ãŒè–„ã„ã€‚å®ˆã‚Šã‚’ç«‹ã¦ç›´ã•ãªã„ã¨æ”»ã‚ã‚‹è³‡æ ¼ãŒãªã„ã‚ˆã€‚ã€`;
  }
  return null;
}

function getCoachLine(tag){
  if(!selectedCoach || !selectedCoach.quotes){
    return "å°ã•ãªä¸€æ­©ãŒæœªæ¥ã‚’å¤‰ãˆã‚‹ã‚ˆã€‚";
  }
  const pool = (selectedCoach.quotes[tag] && selectedCoach.quotes[tag].length)
    ? selectedCoach.quotes[tag]
    : Object.values(selectedCoach.quotes).flat();
  if(!pool || !pool.length){
    return "å°ã•ãªä¸€æ­©ãŒæœªæ¥ã‚’å¤‰ãˆã‚‹ã‚ˆã€‚";
  }
  return pool[Math.floor(Math.random()*pool.length)];
}

function buildDialogueScript(eventData, choice, coachLine){
  const coachName = selectedCoach ? selectedCoach.name : 'ã‚³ãƒ¼ãƒ';
  const summary = describeChoiceDeltaText(choice);
  const lines = [
    { speaker:'ã‚ãªãŸ', text:`${eventData.m}ã€Œ${eventData.text}ã€ã€‚${choice.label}ã‚’é¸ã‚“ã§ã¿ãŸã‚ˆã€‚` },
    { speaker:coachName, text:coachLine },
    { speaker:coachName, text:`ä»Šå›ã®å¤‰åŒ–ã¯ ${summary}ã€‚ã“ã®æµã‚Œã‚’æ¬¡ã®æœˆã«ã¤ãªã’ã‚ˆã†ã€‚` }
  ];
  const tough = getToughLoveMessage(choice);
  if(tough){
    lines.push({ speaker:coachName, text:tough });
  }
  return lines;
}

function openDialogue(lines, onClose){
  const overlay = document.getElementById('dialogueOverlay');
  const listEl = document.getElementById('dialogueList');
  if(!overlay || !listEl){
    if(typeof onClose === 'function'){ onClose(); }
    return false;
  }
  listEl.innerHTML = '';
  lines.forEach(line => {
    const row = document.createElement('div');
    row.className = 'dialogue-line';
    const speaker = document.createElement('div');
    speaker.className = 'dialogue-speaker';
    speaker.textContent = line.speaker;
    const text = document.createElement('div');
    text.className = 'dialogue-text';
    text.textContent = line.text;
    row.appendChild(speaker);
    row.appendChild(text);
    listEl.appendChild(row);
  });
  overlay.classList.add('visible');
  dialogueState = { active:true, onClose };
  return true;
}

function closeDialogue(){
  if(!dialogueState.active) return;
  const overlay = document.getElementById('dialogueOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  const cb = dialogueState.onClose;
  dialogueState = { active:false, onClose:null };
  if(typeof cb === 'function'){ cb(); }
}

function renderStorySlide(){
  if(!storyState.active) return;
  const overlay = document.getElementById('storyOverlay');
  if(!overlay) return;
  const chapterIdx = storyState.chapterIndex;
  const story = chapterStories[chapterIdx];
  const slide = story.slides[storyState.slide];
  document.getElementById('storyChapter').textContent =
    chapterInfo[chapterIdx]?.label || `Chapter ${chapterIdx+1}`;
  document.getElementById('storyText').innerHTML = slide.text;
  document.getElementById('storyMissionHint').textContent =
    `ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼š${story.mission.title} â€” ${story.mission.desc}`;
  const nextBtn = document.getElementById('storyNext');
  if(nextBtn){
    nextBtn.textContent = (storyState.slide === story.slides.length-1) ? 'æ—…ã‚’é€²ã‚ã‚‹' : 'ç¶šãã‚’èª­ã‚€';
  }
}

function openChapterStory(index, onComplete){
  const overlay = document.getElementById('storyOverlay');
  if(!overlay || !chapterStories[index]){
    if(typeof onComplete === 'function'){ onComplete(); }
    return;
  }
  storyState = { active:true, chapterIndex:index, slide:0, onComplete };
  overlay.classList.add('visible');
  renderStorySlide();
}

function advanceStorySlide(){
  if(!storyState.active) return;
  const story = chapterStories[storyState.chapterIndex];
  if(storyState.slide < story.slides.length-1){
    storyState.slide++;
    renderStorySlide();
  } else {
    finishStory();
  }
}

function finishStory(skip=false){
  if(!storyState.active) return;
  const overlay = document.getElementById('storyOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  const idx = storyState.chapterIndex;
  const cb = storyState.onComplete;
  storyState = { active:false, chapterIndex:null, slide:0, onComplete:null };
  if(typeof idx === 'number'){
    chapterIntroPlayed[idx] = true;
    const story = chapterStories[idx];
    if(story && story.mission){
      startMission(story.mission);
    }
  }
  if(typeof cb === 'function'){
    setTimeout(cb, 100);
  }
}

// ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
const storyNextBtn = document.getElementById('storyNext');
const storySkipBtn = document.getElementById('storySkip');
if(storyNextBtn){ storyNextBtn.addEventListener('click', advanceStorySlide); }
if(storySkipBtn){ storySkipBtn.addEventListener('click', () => finishStory(true)); }
const dialogueNextBtn = document.getElementById('dialogueNext');
if(dialogueNextBtn){ dialogueNextBtn.addEventListener('click', closeDialogue); }
const goalSkipBtn = document.getElementById('goalSkip');
const goalBackBtn = document.getElementById('goalBackStep');
const goalNextBtn = document.getElementById('goalNextStep');
const goalManualToggleBtn = document.getElementById('goalManualToggle');
const goalManualBackBtn = document.getElementById('goalManualBack');
const goalManualConfirmBtn = document.getElementById('goalManualConfirm');
const goalAcceptRecommendationBtn = document.getElementById('goalAcceptRecommendation');
const reviewCloseBtn = document.getElementById('reviewCloseButton');
const coachIntroContinueBtn = document.getElementById('coachIntroContinue');
const quizContinueBtn = document.getElementById('quizContinue');
if(goalSkipBtn){ goalSkipBtn.addEventListener('click', () => confirmGoalSetting(true)); }
if(goalBackBtn){ goalBackBtn.addEventListener('click', rewindGoalWizard); }
if(goalNextBtn){ goalNextBtn.addEventListener('click', advanceGoalWizard); }
if(goalManualToggleBtn){ goalManualToggleBtn.addEventListener('click', startGoalManualEdit); }
if(goalManualBackBtn){ goalManualBackBtn.addEventListener('click', backToGoalSummary); }
if(goalManualConfirmBtn){
  goalManualConfirmBtn.addEventListener('click', () => {
    const moneyInput = parseInt(document.getElementById('manualGoalMoney').value, 10);
    const happyInput = parseInt(document.getElementById('manualGoalHappy').value, 10);
    confirmGoalSetting(false, { money: moneyInput, happy: happyInput });
  });
}
if(goalAcceptRecommendationBtn){
  goalAcceptRecommendationBtn.addEventListener('click', () => {
    confirmGoalSetting(false, goalWizard?.proposal || computeGoalProposal());
  });
}
if(reviewCloseBtn){
  reviewCloseBtn.addEventListener('click', closeHalfYearReview);
}
if(coachIntroContinueBtn){
  coachIntroContinueBtn.addEventListener('click', closeCoachIntro);
}
if(quizContinueBtn){
  quizContinueBtn.addEventListener('click', closeSeminarQuiz);
}

function updateStatus(){
  const monthLabel = monthlyEvents[turn] ? monthlyEvents[turn].m : 'çµæœ';
  const totalMonths = monthlyEvents.length;
  const displayTurn = Math.min(turn+1, totalMonths);
  document.getElementById('status').innerHTML =
    `ğŸ“… ${monthLabel}ã€€ï¼ˆ${displayTurn}/${totalMonths}ï¼‰<br>`+
    `ğŸ’µ æ‰€æŒé‡‘: ï¿¥${money}ã€€`+
    `ğŸ’– å¹¸ç¦åº¦: ${happy}`;
  updateChapterBanner();
  applySeasonTheme();
  updateMeters();
  updateGoalIndicator();
}

function renderCoachSelect(){
  const eventEl = document.getElementById('event');
  const ch = document.getElementById('choices');
  const coachBox = document.getElementById('coach');
  document.getElementById('status').innerHTML = 'ğŸ‘©â€ğŸ« ã¾ãšã¯ã‚³ãƒ¼ãƒã‚’é¸ã‚“ã§ãã ã•ã„';
  updateChapterBanner();
  applySeasonTheme();
  updateMeters();
  renderBadges();
  renderLog();
  activeMission = null;
  updateMissionBoard();
  dialogueState = { active:false, onClose:null };
  awaitingDialogue = false;
  goalPlan = null;
  updateGoalIndicator();
  const dialogueOverlay = document.getElementById('dialogueOverlay');
  if(dialogueOverlay){ dialogueOverlay.classList.remove('visible'); }
  coachBox.style.display = 'none';

  const cards = Object.values(coachProfiles).map(p => `
    <div class='coach-card'>
      <img src='${p.avatarSrc}' alt='${p.name}'>
      <div class='coach-title'>${p.name}</div>
      <div class='coach-desc'>${p.desc}</div>
      <button data-key='${p.key}'>ã“ã®ã‚³ãƒ¼ãƒã‚’é¸ã¶</button>
    </div>`).join('');

  eventEl.innerHTML = `<h3>ã‚³ãƒ¼ãƒã‚’é¸æŠ</h3><p>é›°å›²æ°—ã®åˆã†ã‚³ãƒ¼ãƒã‚’é¸ã‚“ã§ã€1å¹´ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>`;
  ch.classList.remove('row');
  ch.innerHTML = `<div class='select-wrap'>${cards}</div>`;

  ch.querySelectorAll('button[data-key]').forEach(btn => {
    btn.onclick = () => {
      const key = btn.getAttribute('data-key');
      startGameWithCoach(key);
    };
  });
}

function startGameWithCoach(key){
  selectedCoach = coachProfiles[key];
  turn = 0;
  money = START_MONEY;
  happy = START_HAPPY;
  for(const k in tagPickCount){ delete tagPickCount[k]; }
  unlockedBadges.clear();
  logEntries.length = 0;
  monthHistory.length = 0;
  completedReviews.clear();
  completedQuizTurns.clear();
  quizCycleIndexYear1 = 0;
  quizCycleIndexYear2 = 0;
  chapterIntroPlayed = chapterInfo.map(()=>false);
  activeMission = null;
  storyState = { active:false, chapterIndex:null, slide:0, onComplete:null };
  dialogueState = { active:false, onClose:null };
  awaitingDialogue = false;
  goalPlan = null;
  reviewState = { active:false, onClose:null };
  quizState = { active:false, onClose:null, quiz:null, answered:false };
  const overlay = document.getElementById('storyOverlay');
  if(overlay){ overlay.classList.remove('visible'); }
  const dOverlay = document.getElementById('dialogueOverlay');
  if(dOverlay){ dOverlay.classList.remove('visible'); }
  const reviewOverlay = document.getElementById('reviewOverlay');
  if(reviewOverlay){ reviewOverlay.classList.remove('visible'); }
  const quizOverlay = document.getElementById('quizOverlay');
  if(quizOverlay){ quizOverlay.classList.remove('visible'); }
  document.getElementById('choices').classList.add('row');
  renderBadges();
  renderLog();
  updateMissionBoard();
  updateStatus();
  openCoachIntro();
}

function showCoach(tag, message){
  const box = document.getElementById('coach');
  if(!selectedCoach){ box.style.display='none'; return; }
  const line = message || getCoachLine(tag);
  box.style.display = 'flex';
  box.innerHTML = `
    <div class="coach-avatar"><img src='${selectedCoach.avatarSrc}' alt='${selectedCoach.name}'></div>
    <div class="coach-text">
      <div class="coach-name">${selectedCoach.name}</div>
      <div>${line}</div>
    </div>`;
  // å†ç”Ÿã‚¢ãƒ‹ãƒ¡
  box.style.animation = 'none';
  void box.offsetWidth; // reflow
  box.style.animation = 'fadeInUp 0.8s ease forwards';
}

function handleChoice(eventData, choice){
  if(awaitingDialogue || storyState.active) return;
  awaitingDialogue = true;
  sparkleEffect();
  const beforeMoney = money;
  const beforeHappy = happy;
  money += choice.money || 0;
  happy += choice.happy || 0;
  tagPickCount[choice.tag] = (tagPickCount[choice.tag]||0)+1;
  addLogEntry(eventData.m, choice.label, choice);
  recordMonthHistory({
    turnIndex: turn,
    monthLabel: eventData.m,
    choiceLabel: choice.label,
    tag: choice.tag,
    moneyDelta: choice.money || 0,
    happyDelta: choice.happy || 0,
    beforeMoney,
    beforeHappy,
    afterMoney: money,
    afterHappy: happy
  });
  handleMissionProgress(choice.tag);
  evaluateBadges(choice);
  const coachLine = getCoachLine(choice.tag);
  showCoach(choice.tag, coachLine);
  updateStatus();
  const dialogueLines = buildDialogueScript(eventData, choice, coachLine);
  const proceed = () => {
    awaitingDialogue = false;
    turn++;
    updateStatus();
    const finalize = () => setTimeout(nextEvent, 320);
    runPostTurnSequence(turn, finalize);
  };
  const opened = openDialogue(dialogueLines, proceed);
  if(!opened){
    proceed();
  }
}

function runPostTurnSequence(currentTurn, done){
  if(shouldTriggerQuiz(currentTurn)){
    openSeminarQuiz(currentTurn, () => runPostTurnSequence(currentTurn, done));
    return;
  }
  if(shouldTriggerReview(currentTurn)){
    openHalfYearReview(currentTurn, done);
    return;
  }
  done();
}

function nextEvent(){
  // ã‚³ãƒ¼ãƒæœªé¸æŠãªã‚‰é¸æŠç”»é¢ã¸
  if(!selectedCoach){ renderCoachSelect(); return; }
  if(turn >= monthlyEvents.length){ endGame(); return; }
  const chapterIdx = getChapterIndex();
  if(!chapterIntroPlayed[chapterIdx]){
    openChapterStory(chapterIdx, nextEvent);
    return;
  }
  const e = monthlyEvents[turn];
  document.getElementById('event').innerHTML = `<strong>${e.m}</strong><br><p>${e.text}</p>`;
  const ch = document.getElementById('choices');
  ch.innerHTML = '';
  e.choices.forEach(c => {
    const b = document.createElement('button');
    b.textContent = c.label;
    b.onclick = () => handleChoice(e, c);
    ch.appendChild(b);
  });
  updateStatus();
}

function endGame(){
  let type = '';
  if(happy > 70 && money > 60000) type = 'ğŸ’ ãƒãƒ©ãƒ³ã‚¹ç¾äººã‚¿ã‚¤ãƒ—';
  else if(happy > 70) type = 'ğŸŒ· ãƒãƒ¼ãƒˆãƒ•ãƒ«ã‚¿ã‚¤ãƒ—';
  else if(money > 70000) type = 'ğŸ“ˆ ã‚°ãƒ­ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—';
  else type = 'ğŸ’­ ãƒã‚¤ãƒšãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—';

  // å€‹åˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆç°¡æ˜“ï¼‰
  const tips = [];
  if((tagPickCount.overseas||0)===0) tips.push('æµ·å¤–åˆ†æ•£ã®ä¸€æ­©ã‚’æ¥å¹´ã¯æ¤œè¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ˆETF/æŠ•ä¿¡ã®å°‘é¡ã‹ã‚‰ï¼‰ã€‚');
  if((tagPickCount.rebalance||0)<2) tips.push('å¹´1ã€œ2å›ã®â€œãƒªãƒãƒ©ãƒ³ã‚¹â€ã§ã€æ„Ÿæƒ…ã§ã¯ãªãè¨­è¨ˆã§é‹ç”¨ã‚’ã€‚');
  if((tagPickCount.health||0)===0) tips.push('å¥åº·ã¯é•·ç”Ÿãé…å½“ã€‚å°ã•ãç¶šã‘ã‚‹ç¿’æ…£ã‚’ã€‚');
  if(money < 40000) tips.push('æ‰€æŒé‡‘ã®ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‚’å¢—ã‚„ã™ãŸã‚ã€å›ºå®šè²»ã¨å‰¯åå…¥ã®ä¸¡é¢ã‚’ç‚¹æ¤œã—ã¾ã—ã‚‡ã†ã€‚');

  const goalSummary = goalPlan ? `
      <strong>ç›®æ¨™ã®æŒ¯ã‚Šè¿”ã‚Š</strong>
      <ul>
        <li>ğŸ’µ æ‰€æŒé‡‘ï¼š${money >= goalPlan.money ? 'é”æˆï¼' : `ã‚ã¨ï¿¥${(goalPlan.money - money).toLocaleString()}`}</li>
        <li>ğŸ’– å¹¸ç¦åº¦ï¼š${happy >= goalPlan.happy ? 'é”æˆï¼' : `ã‚ã¨${goalPlan.happy - happy}`}</li>
      </ul>` : '';

  document.getElementById('event').innerHTML = `
    <h3>çµæœç™ºè¡¨</h3>
    <p>ã‚ãªãŸã¯ <strong>${type}</strong> ã§ã—ãŸã€‚</p>
    <div style="text-align:left; max-width:600px; margin:12px auto; background:#fff7fb; border:1px solid #f0cfe1; padding:12px; border-radius:10px;">
      <strong>è¬›åº§ãƒã‚¤ãƒ³ãƒˆï¼ˆè¦ç‚¹ï¼‰</strong>
      <ul>
        <li>é•·æœŸãƒ»åˆ†æ•£ãƒ»ç¶™ç¶šãŒåŸºæœ¬ã€‚ç©ã¿ç«‹ã¦ã¯æœªæ¥ã¸ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€‚</li>
        <li>æµ·å¤–æŠ•è³‡ã¯â€œä¸–ç•Œã§ãŠé‡‘ã‚’åƒã‹ã›ã‚‹â€ã“ã¨ã€‚é€šè²¨ãƒªã‚¹ã‚¯ã¯å­¦ã³ã§è»½æ¸›ã€‚</li>
        <li>å›ºå®šè²»ã®è¦‹ç›´ã—ã¨ç›®çš„åˆ¥å£åº§ã§ã€è¿·ã„ã‚’æ¸›ã‚‰ã—ã¦ç¶šã‘ã‚„ã™ãã€‚</li>
        <li>å¹´1ã€œ2å›ã®ãƒªãƒãƒ©ãƒ³ã‚¹ã§ã€è¨­è¨ˆå›³ã«æ²¿ã£ãŸé‹ç”¨ã‚’ã€‚</li>
      </ul>
      <div style="text-align:center; margin-top:14px;">
        <a href="https://www.instagram.com/kaorin_family/" target="_blank" style="display:inline-block; background:#d06ba0; color:#fff; padding:10px 18px; border-radius:8px; text-decoration:none; font-weight:600; text-decoration:none;">
          ğŸ’¡ ãŠé‡‘ã®ã‚»ãƒŸãƒŠãƒ¼ã«å‚åŠ ã™ã‚‹ï¼ˆç”³ã—è¾¼ã¿ï¼‰
        </a>
      </div>
      ${goalSummary}
      ${tips.length?('<strong>ã‚ãªãŸã¸ã®ã²ã¨ã“ã¨</strong><ul>'+tips.map(t=>`<li>${t}</li>`).join('')+'</ul>'):''}
    </div>
  `;
  document.getElementById('choices').innerHTML = '<button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶ï¼ˆã‚³ãƒ¼ãƒé¸ã³ã‹ã‚‰ï¼‰</button>';
  showCoach('ending');
  sparkleEffect(40);
}

function sparkleEffect(count=10){
  for(let i=0;i<count;i++){
    const s=document.createElement('div');
    s.className='sparkle';
    s.style.left=Math.random()*100+'vw';
    s.style.animationDuration=(3+Math.random()*2)+'s';
    document.body.appendChild(s);
    setTimeout(()=>s.remove(),4000);
  }
}

// é–‹å§‹ï¼šã¾ãšã¯ã‚³ãƒ¼ãƒé¸æŠç”»é¢
nextEvent();
</script>
</body>
</html>
